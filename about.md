# Про всё подряд

*Документ актуален на 9 апреля 2015 года.*

## Общая архитектура

Используется достаточно традиционный стек:

* PostgreSQL. Раньше был MySQL, но Postgres, особенно свежий, гораздо лучше и
умеет гораздо больше;
* Python 2. Третий питон не поддерживался, по крайней мере раньше, какой-то
частью используемых библиотек. Большая часть кода проекта должна быть совместима
с Python 3 без больших проблем;
* Django;
* uwsgi;
* nginx для обратного проксирования uwsgi и отдачи статики. Вся статика отдаётся
с очень большим TTL, для сache busting'а используются хеши файлов
(см. [ManifestStaticFilesStorage](https://docs.djangoproject.com/en/1.7/ref/contrib/staticfiles/#django.contrib.staticfiles.storage.ManifestStaticFilesStorage));
* немного модифицированный Bootstrap 3. Т.к. патчи накладывались прямо на файлы
Bootstrap'а, обновить его без боли не получится;
* jQuery + underscore.js;
* markdown, подсветка синтаксиса и latex рендерятся в браузере после загрузки,
всё это вместе называется в коде Ubertext (см. ниже).


## Сторонние сервисы

Сайт CSC использует ряд сторонних сервисов, которые описаны в этом разделе.

### AWS

Хостинг всего осуществляется на AWS, в Франкфуртской зоне (на сегодня это
ближайшая к РФ зона AWS). «Главный» ssh-ключ, с которым осуществляется
развёртывание, есть у Екатерины Лебедевой и у Сергея Лебедева. Сам аккаунт нужно
получить у администраторов JetBrains. Затраты по поддержке серверной
инфраструктуры несёт JetBrains, последняя договорённость была на сумму меньшую
или равную $75 в месяц. Текущие затраты несколько меньше, поэтому есть запас для
расширения инфраструктуры, если это будет необходимо. С вопросами можно
обратиться к Сергею Жукову, sergey.zhukov@jetbrains.com, или создать issue в
YouTrack'е JetBrains.

Действия, необходимые для развёртывания сайта на новом аккаунте, описаны в
`infrastructure/README.md`.

NB: очень желательно использовать двухфакторную авторизацию для входа в консоль
AWS.

### NewRelic

Для мониторинга производительности используется NewRelic. Аккаунт можно получить
у Екатерины Лебедевой и Сергея Лебедева. NewRelic даёт подробную статистику по
времени ответа uwsgi-сервера и по времени рендеринга у клиента, позволяя
оценивать среднюю производительность и видеть аномально медленные
страницы. Кроме того, у NewRelic'а есть настраиваемый alert о недоступности
страницы, что весьма удобно по сравнению с жалобами пользователей. В отличие от
упомянутого далее Sentry, этот alert внешний и срабатывает вне зависимости от
причины неработоспосбности сайта — например, при отказе NS-серверов.

На текущий момент используется бесплатный Light аккаунт. Pro ощутимо удобнее
(например, позволяет автоматически собирать трассы медленных транзакций), но
дорог и на сегодня договориться о бесплатном аккаунте для образовательного
учреждения не удалось (возможно, стоит попробовать ещё раз).

### Sentry

Sentry — сервис, собирающий стектрейсы ошибок на сервере и в браузере
клиента. Аккаунт можно получить у Екатерины Лебедевой и Сергея Лебедева. Прямо
сейчас проблемой является очень большое количество ошибок из браузера, связанное
с нестабильной работой CDN (подробнее об этом ниже), поэтому их фильтрация или
(предпочитетельно) решение необходимо в среднесрочной перспективе.

Используется бесплатный аккаунт, т.к. его лимитов, вроде бы, хватает.

### Travis

Для CI используется приватный Travis CI, автоматически собирающий каждый push в
GitHub-репозиторий (можно открыть кликом на бадж в README.md в корне). Вроде бы
не требует отдельного аккаунта, поскольку использует авторизацию
GitHub'а. Приватный аккаунт предоставлен Travis CI бесплатно для
образовательного учреждения (возможно, стоит их порекламировать где-нибудь).


## Обратить внимание

В этом разделе описывается несколько моментов, которые стоит держать в голове.

### SSL-cертификат

Сейчас используется бесплатный сертификат на год от
[StartSSL.org](https://startssl.org) **с датой окончания 28 января 2016**. Очень
важным является обновление сертификата *до* этой даты, т.к. отключить TLS
*быстро* будет нельзя из-за HSTS (см. ниже). В середине 2015 должен заработать
[Let's Encrypt](https://letsencrypt.org/), вероятно, они будут более удобными,
чем StartSSL.

NB: без TLS пароли пользователей передаются по сети в открытом виде, что
недопустимо.

### HSTS

[HSTS](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) —
принципиально важный компонент развёртывания TLS сегодня, поскольку без него
становится возможным
[SSL stripping](https://en.wikipedia.org/wiki/Moxie_Marlinspike#Notable_research). В
связи с этим nginx отдаёт хедер Strict-Transport-Security с таймаутом в 6
месяцев. Это не должно быть проблемой, если всё хорошо, но делает проблематичным
«легитимное» отключение TLS.

### Домен и регистратор

Регистратором домена compscicenter.ru является RU-CENTER, владельцем — компания
Яндекс. Для домена включено автопродление, поэтому с ним не должно быть
проблем. Помочь решить проблемы с регистратором может помочь Евгения Куликова
(lilosea@yandex-team.ru), конкретный человек, которым занимался изменениями —
Татьяна Бахаревская (tvt@yandex-team.ru).

В качестве NS-cерверов сейчас используется Route53 на AWS, соответственно,
управление записями осуществляется из панели AWS.

### Бекапы на S3

Каждую ночь в 4:00 по серверному времени снимается полный бекап базы и media
(залитых пользователями файлов). Бекап заливается на S3 в папку с hostname и
временем; для соответствующего bucket'а настроен TTL в 30 дней, поэтому в любой
момент времени доступны посуточные бекапы за последний месяц.


## KPI

Подчеркну отдельно два важных KPI, падения которых стоит избегать.

### Время ответа сервера

Есть шесть разных способов, которыми можно замерить время ответа сервера:

1. локальное тестирование с Django Debug Toolbar'ом. Наиболее грубый способ, но
позволяет обнаружить вырожденные случаи;
2. логи uwsgi, в которых пишется время ответа на конкретный запрос. Хороший
способ убедиться в адекватности цифр, которые показывает NewRelic. Естественно, при этом
совершенно не учитывается сетевая задержка и задержка от nginx'а;
3. access-логи nginx (обычно отключены);
4. web transactions response time в разделе servers на NewRelic. Цифры здесь
должны примерно совпадать с логами uwsgi, но их гораздо удобнее
просматривать. *latency здесь нужно стараться держать меньшей, чем 100
миллисекунд*, т.к. ещё есть сетевые задержки;
5. browser page load time в разделе browser на NewRelic. Это суммарное время
загрузки страницы, учитывающее загрузку всех ресурсов и работу JS. *числа в этом
разделе желательно удерживать в диапазоне «до 2–3 секунд»* — страница
отображается в современных браузерах немного раньше, чем оканчивается её
загрузка, но суммарное время не должно быть слишком большим.
6. time to first byte для .html в табе network в dev tools любимого браузера. *В
условиях идеальной сети (вроде офисной в JB) это число не должно превышать 200
миллисекунд*, по крайней мере для часто используемых страниц вроде страницы
курса.

### Отсутствие ошибок

Здесь всё гораздо проще: в нормальном режиме работы Sentry не должен сообщать об
ошибках и варнингах сервера вообще.


## Разное

### Ubereditor/ubertext

Эти названия используются в коде и иногда в документации. Под ними
подразумевается редактор, используемый для ввода многострочного текста с
поддержкой markdown'а, подсветки кода и latex'а, и сам такой текст. С точки
зрения Django, Ubereditor это просто widget для TextField'а, представляющий из
себя настроенный [EpicEditor](http://epiceditor.com/); Ubertext это класс на
div'е, который использутся JS'ом для рендеринга при событии DOM ready.

### Персистентность комментариев

Комментарии к заданиям бывают достаточно длинными и очень неприятно терять их
из-за случайно закрытой вкладки или ошибки сети. Чтобы избежать этого, был
добавлен механизм «персистентных комментариев», состоящий из двух частей:
регулярное сохранение комментария в HTML5 localStorage (это просто и
поддерживается в EpicEditor'е) и инвалидация сохранённого комментария *в случае
успешной его записи в БД*. Последняя часть важна, т.к. большинство существующих
решений удаляют сохранённый комментарий *при отправке формы*, что делает
неизбежной потерю комментария в случае сетевой ошибки или ошибки сервера.

Нетривиальность последней части заключается в том, что традиционная
request-reply модель подразумевает, что статус сохранения комментария известен
только конкретному хендлеру, отвечающему браузеру редиректом. Так как мы не
можем исполнять JS во время редиректа, нужно как-то сообщить браузеру, что
запись прошла успешно, «через» редирект. Одним из разумных вариантов выглядит
установка cookie при редиректе с последующим чтением её из JS, но в хроме есть
баг, из-за которого он игнорирует Set-Cookie на редиректе. Поэтому был
реализован следующий подхак:

* если сохранение комментария успешно (это определяется в `form_valid`), часть
его хеша (уникальная для конкретного текста) сохраняется в джанговый кеш (общий
для всех воркеров) под определённым ключём с небольшим TTL;
* на страницу с «персистентным» комментарием в inline JS подставляется строчка с
кусочками хешей;
* в JS проверяется, не совпадает ли хеш сохранённого комментария с уже
существующими, и если да, то он удаляется из localStorage.

В ретроспективе видится два возможных улучшения:

* использование сессии вместо общего кеша;
* переход на исключительно AJAX отправку комментариев, что полностью решит эту
проблему, т.к. в JS мы будем знать, состоялась ли запись.

### Отправка по Ctrl+Enter

Для форм, которые часто отправляются (комментарии к заданиям, ведомость)
добавлена поддержка отправки формы по Ctrl+Enter. Это удобное неявное
соглашение, которое используется много где, и его лучше не потерять при
рефакторингах и переписываниях.


## Идеи, планы, мысли

В этом разделе описаны идеи и планы для дальнейшего развития проекта. Здесь
будет меньше структуры, так как это скорее brain dump от предыдущего
разработчика. Этот раздел призван дополнить issues в репозитории; там, где это
уместно, будут даны ссылки на существующие issue.

### Решение проблем с загрузкой JS

### Task queue

### Ускорение рендеринга шаблонов

### Более годные формы

### Переход на AsciiDoc(tor)

  - latex + code
  - блоки
  - https://github.com/jonschlinkert/remarkable

### Сайт Клуба

### Multiple upload

### Редизайн

### oEmbed

### Миграция на SES

### Индексы для поиска имён студентов

### BREACH

* решить проблемы с загрузкой JS (отказ от CDN, минификация, переход на CLJS)
* ускорить рендеринг шаблонов — подозрение на меню
* более годные формы: ubereditor, формат даты, "миниформы"
* AsciiDoctor
* сайт Клуба
* multiple upload
* редизайн (меню и мобилы)
* oEmbed
* миграция на SES
* индексы для поиска имён, если это станет проблемой
* BREACH
