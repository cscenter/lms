# System Patterns *Optional*

This file documents recurring patterns and standards used in the project.
It is optional, but recommended to be updated as the project evolves.
2025-04-25 11:19:00 - Log of updates made.

*

## Coding Patterns

* **Все комментарии в коде должны быть написаны исключительно на английском языке.**

* **Модульная архитектура**
  - Использование Django приложений для разделения функциональности
  - Четкое разделение ответственности между приложениями
  - Повторное использование компонентов между разными сайтами

* **Слоистая архитектура**
  - Models: определение структуры данных и бизнес-логики
  - Views: обработка HTTP-запросов и формирование ответов
  - Services: инкапсуляция бизнес-логики и операций
  - Selectors: извлечение данных из базы данных
  - Forms: валидация входных данных
  - Serializers: преобразование данных для API
  - Resources: импорт/экспорт данных (django-import-export)

* **Контроль доступа**
  - Использование permissions для детального контроля доступа
  - Ролевая модель для разграничения прав пользователей
  - Middleware для проверки аутентификации и авторизации
  - Миксины для ограничения доступа к представлениям (например, CuratorOnlyMixin)

* **Обработка событий**
  - Использование Django signals для слабосвязанной коммуникации между компонентами
  - Асинхронная обработка событий через Celery

* **Шаблонизация**
  - Использование Jinja2 для шаблонов
  - Разделение логики и представления
  - Использование включаемых шаблонов для повторного использования кода (например, _results_tab.html)

* **Паттерн Mixin**
  - Использование миксинов для добавления функциональности к классам
  - Примеры: CuratorOnlyMixin, ApplicantRandomizeContestMixin
  - Позволяет избежать дублирования кода и улучшает его поддерживаемость

* **Паттерн Factory Method**
  - Использование фабричных методов для создания объектов
  - Пример: методы get_testing_record(), get_exam_record(), get_olympiad_record() в модели Applicant
  - Инкапсулирует логику создания объектов и делает код более гибким

## Architectural Patterns

* **Многосайтовая архитектура**
  - Общий код в директории lms/
  - Специфичный код для каждого сайта в отдельных директориях
  - Использование Django Sites Framework для разделения контента

* **Интеграция с внешними сервисами**
  - Yandex.Contest: проверка заданий по программированию и проведение олимпиад
    - Использование API-клиента YandexContestAPI для взаимодействия с API Yandex.Contest
    - Обработка ошибок API через специализированные исключения (ContestAPIError, YandexContestAPIException)
    - Кэширование токенов доступа и их обновление при необходимости
    - Абстракция взаимодействия с API через сервисные классы
  - Gerrit: система код-ревью
  - Yandex.Disk: хранение файлов
  - Yandex.Passport: аутентификация пользователей
  - LDAP: интеграция с корпоративными системами

* **Кэширование и очереди**
  - Redis для кэширования данных и управления очередями
  - Celery для асинхронной обработки задач
  - Планировщик задач для периодических операций

* **API-ориентированная архитектура**
  - REST API для взаимодействия с фронтендом
  - Документация API через Swagger/OpenAPI
  - Версионирование API

* **Масштабируемость**
  - Контейнеризация с использованием Docker
  - Оркестрация через Kubernetes
  - Горизонтальное масштабирование компонентов

* **Паттерн Context Provider**
  - Использование функций для подготовки контекста для шаблонов
  - Пример: get_applicant_context() для подготовки данных для страницы деталей абитуриента
  - Позволяет повторно использовать логику подготовки данных в разных представлениях

* **Паттерн Service Layer**
  - Выделение бизнес-логики в отдельные сервисные функции и классы
  - Пример: YandexContestAPI для взаимодействия с Yandex.Contest
  - Улучшает тестируемость и поддерживаемость кода

## Testing Patterns

* **Фреймворк тестирования**
  - Использование pytest для модульных и интеграционных тестов
  - Отдельные директории tests/ в каждом приложении
  - Конфигурация тестов через pytest.ini

* **Организация тестовых данных**
  - Использование фикстур для подготовки тестовых данных
  - Factory Boy для генерации тестовых объектов
  - Моки и стабы для изоляции компонентов

* **Типы тестов**
  - Модульные тесты для отдельных компонентов
  - Интеграционные тесты для проверки взаимодействия компонентов
  - Функциональные тесты для проверки пользовательских сценариев
  - API-тесты для проверки REST API

* **CI/CD**
  - Автоматическое выполнение тестов при коммитах
  - Проверка покрытия кода тестами
  - Линтеры для проверки качества кода

## Паттерны моделирования данных

* **Наследование моделей**
  - Использование абстрактных базовых классов для общей функциональности
  - Наследование от базовых моделей для специализированных случаев
  - Пример: `Olympiad` наследуется от `TimeStampedModel` и использует миксины `YandexContestIntegration` и `ApplicantRandomizeContestMixin`

* **Композиция моделей**
  - Связывание моделей через ForeignKey и ManyToMany отношения
  - Использование промежуточных моделей для сложных отношений
  - Пример: `Olympiad` связан с `Applicant` и `Location` через ForeignKey

* **Расширение функциональности**
  - Добавление методов в модели для инкапсуляции бизнес-логики
  - Пример: методы `total_score` и `total_score_display()` в модели `Olympiad` для расчета и форматирования суммы баллов

* **Паттерн Annotation**
  - Использование аннотаций Django ORM для оптимизации запросов
  - Пример: аннотация `olympiad__total_score_coalesce` в методе `get_queryset()` класса `ApplicantListView`
  - Позволяет выполнять вычисления на уровне базы данных, а не в Python-коде

## Паттерны доменной модели

* **Паттерн Status Machine**
  - Использование предопределенных статусов для моделирования жизненного цикла объектов
  - Примеры: ApplicantStatuses, ChallengeStatuses, InterviewInvitationStatuses
  - Четкое определение возможных переходов между статусами
  - Группировка статусов по смыслу (например, ApplicantStatuses.RIGHT_BEFORE_INTERVIEW, ApplicantStatuses.RESULTS_STATUSES)

* **Паттерн Value Object**
  - Использование неизменяемых объектов для представления значений
  - Примеры: AccountData, StudentProfileData (реализованы как @dataclass(frozen=True))
  - Валидация данных при создании объекта
  - Методы-фабрики для создания объектов из словарей (from_dict)

* **Паттерн Domain Service**
  - Выделение бизнес-логики в отдельные сервисные функции
  - Примеры: create_invitation, accept_interview_invitation, create_student_from_applicant
  - Инкапсуляция сложной логики, связанной с несколькими моделями
  - Транзакционная обработка операций

* **Паттерн Specification**
  - Использование предикатов для фильтрации объектов
  - Примеры: фильтры в get_applicants_for_invitation (format_filter, last_name_filter, track_filter, way_filter, miss_filter)
  - Композиция фильтров с использованием операторов Q из Django ORM
  - Повышение читаемости и поддерживаемости кода

## Паттерны командной строки

* **Паттерн Mixin для команд управления**
  - Использование миксинов для добавления функциональности к командам управления
  - Примеры: CurrentCampaignMixin, CustomizeQueryMixin, EmailTemplateMixin
  - Позволяет повторно использовать код и улучшает его поддерживаемость

* **Паттерн Validation Chain**
  - Последовательное выполнение валидаций перед выполнением основной логики команды
  - Примеры: validate_campaign_contests, validate_campaign_passing_score
  - Позволяет рано выявлять ошибки и предотвращать выполнение команды с некорректными данными

* **Паттерн Confirmation Dialog**
  - Запрос подтверждения у пользователя перед выполнением потенциально опасных операций
  - Пример: использование APPROVAL_DIALOG в командах управления
  - Предотвращает случайное выполнение операций, которые могут привести к нежелательным последствиям

* **Паттерн Batch Processing**
  - Обработка данных пакетами для оптимизации производительности
  - Пример: использование пагинации при получении данных из API Yandex.Contest
  - Позволяет эффективно обрабатывать большие объемы данных

* **Паттерн Error Aggregation**
  - Сбор ошибок в список и их обработка после завершения всех проверок
  - Пример: сбор ошибок валидации в список errors и последующее выбрасывание CommandError
  - Позволяет предоставить пользователю полный список проблем, а не только первую обнаруженную ошибку

## Паттерны асинхронной обработки

* **Паттерн Task Queue**
  - Использование очередей задач для асинхронной обработки
  - Примеры: create_contest_results_import_task, get_latest_contest_results_task
  - Отделение запуска задачи от ее выполнения
  - Возможность отслеживания статуса выполнения задачи

* **Паттерн Email Queue**
  - Асинхронная отправка электронных писем
  - Реализация через класс EmailQueueService
  - Методы для генерации различных типов уведомлений (регистрация, приглашение на интервью, напоминание)
  - Предотвращение дублирования писем

* **Паттерн Context Manager**
  - Использование контекстных менеджеров для управления ресурсами
  - Пример: manual_status_change для изменения статуса абитуриента
  - Обеспечение корректного освобождения ресурсов даже при возникновении исключений

## Паттерны безопасности и валидации

* **Паттерн Token Generator**
  - Генерация и проверка токенов для подтверждения действий
  - Примеры: email_code_generator для подтверждения электронной почты
  - Безопасная передача информации между запросами

* **Паттерн Validator**
  - Выделение логики валидации в отдельные функции
  - Примеры: validate_email_template_name, validate_json_container, validate_verification_code
  - Повторное использование валидаторов в разных частях системы

* **Паттерн Atomic Transaction**
  - Использование атомарных транзакций для обеспечения целостности данных
  - Примеры: @transaction.atomic, with transaction.atomic()
  - Использование savepoint для возможности отката части транзакции
