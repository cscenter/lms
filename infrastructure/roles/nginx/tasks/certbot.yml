---

- name: Download and install certbot
  get_url: url=https://dl.eff.org/certbot-auto dest={{ certbot_script }} mode=0755

- name: LetsEncrypt Certbot directory exists
  file:
    path: "{{ item.site_root }}/.well-known/acme-challenge"
    state: directory
    recurse: yes
    owner: "{{ item.site_user }}"
    group: "{{ item.site_user }}"
  with_items: "{{ available_sites }}"

- name: Generate certificates
  command: >
    {{ certbot_script }} certonly --webroot
    --noninteractive --agree-tos
    --email {{ item.admin_email }}
    -w {{ item.site_root }}
    -d {{ item.certbot_domains|join(' -d ') }}
  args:
    creates: "{{ item.certbot_config_dir }}"
  with_items: "{{ available_sites }}"

# Note: the `.` special character matches any character except newlines.
# Note: Make sure nginx configs were copied to `dest` (see `nginx.yml`)
- name: Uncomment `ssl_certificate` and `ssl_certificate_key`
  replace:
    dest: "/etc/nginx/sites-available/{{ item.site_user }}.conf"
    regexp: '^(\s*)# ssl_certificate(.*);$'
    replace: '\1ssl_certificate\2;'
    backup: no
  notify: reload nginx
  with_items:
    - "{{ available_sites }}"

- name: Ensure Nginx is started
  service: name=nginx state=started
  when: nginx_status.stat.exists

- name: Ensure a cron job to auto-renew the cert exists
  cron:
    name: "daily auto renew cert for {{ item.site_domain }}"
    special_time: daily
    job: >
      {{ certbot_script }} certonly --webroot
      --noninteractive --agree-tos --quiet
      --email {{ item.admin_email }}
      -w {{ item.site_root }}
      -d {{ item.certbot_domains|join(' -d ') }}
      --deploy-hook 'service nginx reload'
      --no-self-upgrade
    state: present
  with_items: "{{ available_sites }}"
  when: certbot_auto_renew