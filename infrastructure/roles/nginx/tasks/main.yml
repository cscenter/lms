---
- name: Add nginx PPA
  apt_repository:
    repo: "ppa:nginx/stable"
    update_cache: yes

- name: Install nginx
  apt:
    name: nginx
    state: present

- name: Ensure nginx service is enabled
  systemd:
    name: nginx.service
    enabled: yes

- name: Create dir for nginx crypto stuff
  file:
    path: "{{ nginx_tls_path }}"
    state: directory
  tags:
    - nginx
    - tls

- name: Ensure all nginx crypto materials are present
  copy:
    src: "{{ item.from }}"
    dest: "{{ nginx_tls_path }}/{{ item.to }}"
    mode: 0400
  with_items:
    - from: tls_dhparams.pem
      to: dhparam.pem
  tags:
    - nginx
    - tls

- name: Remove default nginx config
  file: path=/etc/nginx/sites-enabled/default state=absent
  notify: reload nginx
  tags:
    - nginx

- name: Download and install certbot
  get_url: url=https://dl.eff.org/certbot-auto dest={{ certbot_script }} mode=0755
