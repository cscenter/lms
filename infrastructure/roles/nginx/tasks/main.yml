---
- name: Add nginx PPA
  apt_repository:
    repo: "ppa:nginx/stable"
    update_cache: yes

- name: Install nginx
  apt:
    name: nginx
    state: present

- name: Ensure nginx service is enabled
  systemd:
    name: nginx.service
    enabled: yes

- name: Create dir for nginx crypto stuff
  file:
    path: "{{ nginx_tls_path }}"
    state: directory
  when: enable_https
  tags:
    - nginx
    - tls

- name: Ensure all nginx crypto materials are present
  copy:
    src: "{{ item.from }}"
    dest: "{{ nginx_tls_path }}/{{ item.to }}"
    mode: 0400
  when: enable_https
  with_items:
    - from: tls_dhparams.pem
      to: dhparam.pem
  tags:
    - nginx
    - tls

- name: Remove default nginx config
  file: path=/etc/nginx/sites-enabled/default state=absent
  notify: reload_nginx
  tags:
    - nginx

- name: Generate an OpenSSL private key
  openssl_privatekey:
    path: "{{ nginx_tls_path }}/snakeoil-key.pem"
  when: enable_https

- name: Generate an OpenSSL CSR
  openssl_csr:
    path: "{{ nginx_tls_path }}/snakeoil.csr"
    privatekey_path: "{{ nginx_tls_path }}/snakeoil-key.pem"
    common_name: "example.com"
  when: enable_https

- name: Generate a Self Signed OpenSSL certificate
  openssl_certificate:
    path: "{{ nginx_tls_path }}/snakeoil-certificate.pem"
    privatekey_path: "{{ nginx_tls_path }}/snakeoil-key.pem"
    csr_path: "{{ nginx_tls_path }}/snakeoil.csr"
    provider: selfsigned
  when: enable_https

- name: Copy nginx configuration for handling requests with wrong Host header
  template:
    src: "nginx.default_server.conf"
    dest: "/etc/nginx/conf.d/default_server.conf"
  notify: reload_nginx
  tags:
    - nginx
  when: enable_https
