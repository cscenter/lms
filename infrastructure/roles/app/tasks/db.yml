---
- name: Ensure db user exists
  become: yes
  become_user: postgres
  postgresql_user: state=present name="{{ db_user }}" password="{{ db_user_password }}"

- name: Create database
  become: yes
  become_user: postgres
  postgresql_db:
    name: "{{ db_name }}"
    encoding: "UTF-8"
    owner: "{{ db_user }}"
    state: present
  register: db

- name: Ensure user has access to the database
  become: yes
  become_user: postgres
  postgresql_user:
    db: "{{ db_name }}"
    name: "{{ db_user }}"
    priv: ALL
    state: present

- name: Ensure user does not have unnecessary privileges
  become: yes
  become_user: postgres
  postgresql_user:
    name: "{{ db_user }}"
    role_attr_flags: NOSUPERUSER,CREATEDB
    state: present

# TODO: remove? run_once: yes?
- name: Run migrations
  become: yes
  become_user: "{{ site_user }}"
  django_manage:
    command: "migrate"
    app_path: "{{ repo_root }}"
    settings: "{{ site_dir_name }}.settings.{{ app_environment }}"
    virtualenv: "{{ virtualenv_root }}"
