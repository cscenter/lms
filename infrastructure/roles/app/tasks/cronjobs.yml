---
- name: Daily late-night DB backup goes in cron
  become_user: "{{ item }}"
  cron:
    name: backup CSC website DB to S3
    user: "{{ item }}"
    hour: "4"
    minute: "7"
    job: >
      . /home/{{ item }}/site/env/bin/activate &&
      /home/{{ item }}/site/repo/manage.py dbbackup
      --settings={{item}}.settings.{{ app_environment }}
      --pythonpath='/home/{{item}}/site/repo/cscsite'
      >> /home/{{ item }}/site/logs/cscbackup.log
      2>&1
  with_items:
    - "{{ cscenter_user }}"

- name: Daily late-night media backup goes in cron
  become_user: "{{ item }}"
  cron:
    name: backup CSC website media/ dir to S3
    user: "{{ item }}"
    hour: "4"
    minute: "12"
    job: >
      . /home/{{ item }}/site/env/bin/activate &&
      /home/{{ item }}/site/repo/manage.py mediabackup
      --settings={{item}}.settings.{{ app_environment }}
      --compress
      --pythonpath='/home/{{item}}/site/repo/cscsite'
      >> /home/{{ item }}/site/logs/cscbackup.log
      2>&1
  with_items:
    - "{{ cscenter_user }}"

- name: Notify people every 5 minutes (cronjob)
  become_user: "{{ item }}"
  cron:
    name: CSC mail notifier
    user: "{{ item }}"
    minute: "*/5"
    job: >
      . /home/{{ item }}/site/env/bin/activate &&
      /home/{{ item }}/site/repo/manage.py notify
      --settings={{ item }}.settings.{{ app_environment }}
      --pythonpath='/home/{{item}}/site/repo/cscsite'
      >> /home/{{ item }}/site/logs/cscnotifier.log
      2>&1
  with_items:
    - "{{ cscenter_user }}"

- name: remove useless notifications each Wednesday (cronjob)
  become_user: "{{ item }}"
  cron:
    name: CSC notification cleanup
    user: "{{ item }}"
    weekday: 3
    hour: "2"
    minute: "3"
    job: >
      . /home/{{ item }}/site/env/bin/activate &&
      /home/{{ item }}/site/repo/manage.py notification_cleanup
      --settings={{ item }}.settings.{{ app_environment }}
      --pythonpath='/home/{{item}}/site/repo/cscsite'
      >> /home/{{ item }}/site/logs/cscnotifier.log
      2>&1
  with_items:
    - "{{ cscenter_user }}"

- name: Project deadlines notification
  become_user: "{{ item }}"
  cron:
    name: Send project notification about deadline if neccessary
    user: "{{ item }}"
    hour: "1,13"
    minute: "7"
    job: >
      . /home/{{ item }}/site/env/bin/activate &&
      /home/{{ item }}/site/repo/manage.py projects_notifications
      --settings={{ item }}.settings.{{ app_environment }}
      --pythonpath='/home/{{item}}/site/repo/cscsite'
      >> /home/{{ item }}/site/logs/cscnotifier.log
      2>&1
  with_items:
    - "{{ cscenter_user }}"

- name: Once a day remove expired sessions
  become_user: "{{ item }}"
  cron:
    name: Remove expired CSC sessions
    user: "{{ item }}"
    hour: 0
    minute: 7
    job: >
      . /home/{{ item }}/site/env/bin/activate &&
      /home/{{ item }}/site/repo/manage.py clearsessions
      --settings={{ item }}.settings.{{ app_environment }}
      --pythonpath='/home/{{item}}/site/repo/cscsite'
      >> /home/{{ item }}/site/logs/cronjobs.log
      2>&1
  with_items:
    - "{{ cscenter_user }}"

- name: Send queued emails with amazon SES each minute
  become_user: "{{ item }}"
  cron:
    name: Send queued emails with amazon SES
    user: "{{ item }}"
    minute: "*"
    job: >
      . /home/{{ item }}/site/env/bin/activate &&
      /home/{{ item }}/site/repo/manage.py send_queued_mail
      --settings={{ item }}.settings.{{ app_environment }}
      --pythonpath='/home/{{item}}/site/repo/cscsite'
      >> /home/{{ item }}/site/logs/send_queued_mail.log
      2>&1
  with_items:
    - "{{ cscenter_user }}"

- name: Get latest news from social networks for cscenter index page
  become_user: "{{ item }}"
  cron:
    name: Get latest news from social networks for cscenter index page
    user: "{{ item }}"
    minute: "7"
    hour: "12,18,23"
    job: >
      . /home/{{ item }}/site/env/bin/activate &&
      /home/{{ item }}/site/repo/manage.py social_crawler
      --settings={{ item }}.settings.{{ app_environment }}
      --pythonpath='/home/{{item}}/site/repo/cscsite'
      >> /home/{{ item }}/site/logs/cronjobs.log
      2>&1
  with_items:
    - "{{ cscenter_user }}"
