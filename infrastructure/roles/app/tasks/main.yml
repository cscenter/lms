---

- name: Check mandatory variables before doing anything
  fail:
    msg: "Variable '{{ item }}' is not defined"
  when: item not in vars
  loop:
    - main_domain
    - site_user
    - site_user_group
    - repo_root
    - virtualenv_root
    - media_root
    - static_root
    - backup_root
    - site_dir_name
    - apps_dir_name
    - app_environment
    - repo_url
    - db_name
    - db_user
    - db_user_password
    - setup_cronjobs
    - certbot_domains
    - nginx_configs
    - certbot_config_dir
    - rq_workers
    - rq_workers_target_service_name
    - processes_num
    - log_to_file
    - enable_https
  tags:
    - always

# TODO: check uwsgi/nginx configs are exist

- name: Create users and groups
  import_tasks: users.yml
  tags:
    - users

- name: Create application directory structure
  file:
    path: "/home/{{ site_user }}/site/{{ item }}"
    state: directory
    owner: "{{ site_user }}"
  with_items:
    - logs

- name: Clone website repo
  become: yes
  become_user: "{{ site_user }}"
  git:
    accept_hostkey: yes
    repo: "{{ repo_url }}"
    dest: "/home/{{ site_user }}/site/repo"
    key_file: "/home/{{ site_user }}/.ssh/id_rsa"

- name: Ensure directory for file-based cache exists
  file: path=/tmp/django_cache mode=777 state=directory

- name: Nginx status
  stat: path=/etc/init.d/nginx
  register: nginx_status
  tags:
    - nginx
    - certbot

- name: Copy nginx configs
  template:
    src: "{{ nginx_domain }}/nginx.conf.jinja2"
    dest: "/etc/nginx/sites-available/{{ nginx_domain }}.conf"
  notify: reload_nginx
  when: nginx_status.stat.exists
  loop: "{{ nginx_configs }}"
  loop_control:
    loop_var: nginx_domain
  tags:
    - nginx

- name: Symlink nginx configs
  file:
    src: "/etc/nginx/sites-available/{{ nginx_domain }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ nginx_domain }}.conf"
    state: link
  loop: "{{ nginx_configs }}"
  loop_control:
    loop_var: nginx_domain
  tags:
    - nginx
  when: nginx_status.stat.exists

- name: Configure certbot to auto-renew tls certificates
  import_tasks: certbot.yml
  when: nginx_status.stat.exists and enable_https

- name: Ensure Nginx is started
  service: name=nginx state=started
  tags:
    - nginx
  when: nginx_status.stat.exists

- name: Install app dependencies
  import_tasks: venv.yml
  notify: restart_uwsgi
  tags:
    - venv

- import_tasks: systemd.yml
  when: rq_workers|length > 0

- name: Copy uwsgi config
  template:
    src: "{{ main_domain }}/uwsgi.ini.jinja2"
    dest: "/etc/uwsgi/vassals/{{ main_domain }}.ini"
    owner: "{{ site_user }}"
  notify: restart_uwsgi
  tags:
    - uwsgi

- name: Get stat about media root
  stat:
    path: "{{ media_root }}"
  register: media_root_stat

- name: Create media/ directory
  file:
    path: "{{ media_root }}"
    state: directory
    owner: "ubuntu"
    group: "{{ site_user_group }}"
    mode: 0775
  when: not media_root_stat.stat.exists

- name: Restore file and dir owners if "{{ media_root }}" were exist before
  shell: "chown -R {{ site_user }}:{{ site_user_group }} {{ media_root }}"
  become: yes
  run_once: yes
  when: media_root_stat.stat.exists

# Note: not idempotent
- name: Ensure directories are {{ media_directory_permissions }}
  command: find {{ media_root }} -type d -exec chmod {{ media_directory_permissions }} {} \;
  become: yes
  run_once: yes
  when: media_root_stat.stat.exists

# Note: not idempotent
- name: Ensure files are {{ media_file_permissions }}
  command: find {{ media_root }} -type f -exec chmod {{ media_file_permissions }} {} \;
  become: yes
  run_once: yes
  when: media_root_stat.stat.exists

- name: Create tmp directory for django-dbbackup
  file:
    path: "{{ backup_root }}"
    state: directory
    owner: "ubuntu"
    group: "{{ site_user_group }}"
    mode: 0775

- name: Configure db
  import_tasks: db.yml
  tags:
    - db

- name: Run collectstatic
  become_user: "{{ site_user }}"
  django_manage:
    command: "collectstatic"
    app_path: "{{ repo_root }}"
    settings: "{{ site_dir_name }}.settings.{{ app_environment }}"
    virtualenv: "{{ virtualenv_root }}"
  tags:
    - collectstatic

- name: Set up cron jobs
  import_tasks: cronjobs.yml
  when: setup_cronjobs
  tags:
    - cronjobs
