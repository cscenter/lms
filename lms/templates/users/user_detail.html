{% extends "base.html" %}
{% load i18n %}
{% load thumbnail %}
{% load core_tags %}
{% load override_url %}
{% load static %}
{% load render_bundle from webpack_loader %}
{% load markdown from core_tags %}
{% load user_thumbnail from user_thumbnail %}
{% block title %}{{ profile_user.get_short_name }} - {% trans "Profile" %} {% trans "on site" %} Computer Science Center{% endblock title %}

{% block body_attrs %} data-init-sections="profile"{% endblock body_attrs %}


{% block javascripts %}
    <script type="text/javascript">
        {# TODO: How to preload this staff with webpack? #}
        window.profileAppInit = {{ initial|safe }};
        window.profileAppInit["preload"] = [
            "{% static "v1/js/vendor/FileAPI/FileAPI.min.js" %}"
        ];
        {% if user.is_curator %}
            $('.loginas-user').click(function(e) {
                e.preventDefault();
                var href = $(this).attr("href");
                $('<form>', {
                    "method": "POST",
                    "html": '{% csrf_token %}',
                    "action": href
                }).appendTo(document.body).submit();
            });
        {% endif %}
    </script>
{% endblock javascripts %}


{% block content %}
    <div id="profile">
        <header>
            <div class="thumbnail text-center">
                <div class="thumbnail-inner">
                    <div class="thumbnail-img">
                        {% user_thumbnail profile_user profile_user.ThumbnailSize.BASE as im %}
                            <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                        {% enduser_thumbnail %}
                    </div>
                    {% if profile_user.pk == user.pk or user.is_curator %}
                        <div class="photo-actions">
                            <a href="#user-photo-upload">{% trans "Change photo" %}</a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <h2>{{ profile_user.first_name }} {{ profile_user.patronymic }}<br>{{ profile_user.last_name }}
                {% if user.is_curator %}
                    <a href="{% url 'admin:users_user_change' object_id=profile_user.pk %}"
                       target="_blank"><i class="fa fa-pencil-square-o"></i></a> <a title="Войти под пользователем" class="loginas-user" href="{% url 'loginas-user-login' user_id=profile_user.pk %}"><i class="fa fa-ils" aria-hidden="true"></i></a>
                {% endif %}</h2>

            {% if profile_user.is_graduate %}
                {% with graduate_profile=profile_user.graduate_profile %}
                    <div class="progress-info">
                        С сентября {{ student_profile.year_of_admission }} года по июнь {{ graduate_profile.graduation_year }} года<br>
                            {% if profile_user.gender == profile_user.GENDER_FEMALE %}прошла{% else %}прошёл{% endif %}
                            обучение по направлени{{ graduate_profile.academic_disciplines.all|pluralize:"ю,ям" }}
                            {% for program in graduate_profile.academic_disciplines.all %}{{ program.name_en }}{% if not forloop.last and forloop.first != forloop.last %} и {% endif %}{% endfor %}
                    </div>
                {% endwith %}
            {% elif student_profile %}
                <div class="progress-info">
                    {% trans "student"|title %}{% if student_profile.year_of_admission %} {{ student_profile.year_of_admission }} {% trans "enrolled in" context "user_detail" %}{% endif %}{% if not student_profile.is_active %}, {{ student_profile.get_status_display|lower }}{% endif %}
                </div>
            {% elif profile_user.is_teacher %}
                <div class="progress-info">
                    {% trans "teacher"|title %}
                </div>
            {% endif %}
        </header>

        <div class="profile-additional-info">
            {% if profile_user.bio.strip %}
                <div class="about-me">
                    <div class="ubertext">
                        {% markdown 3600 "user_bio" profile_user.pk profile_user.modified %}
                            {{ profile_user.bio }}
                        {% endmarkdown %}
                    </div>
                </div>
            {% elif profile_user.pk == user.pk or user.is_curator %}
                <div class="about-me"></div>
            {% endif %}
            {% if profile_user.is_graduate and profile_user.graduate_profile and profile_user.graduate_profile.testimonial %}
                <div class="review">
                    <h4>{% trans "Review of Computer Science Center" %}</h4>
                    <div class="ubertext">
                        {% markdown 3600 profile_user.graduate_profile.TESTIMONIAL_CACHE_KEY profile_user.graduate_profile.pk profile_user.graduate_profile.modified %}
                            {{ profile_user.graduate_profile.testimonial }}{% endmarkdown %}
                    </div>
                </div>
            {% endif %}
            {% if profile_user.pk == user.pk or user.is_curator %}
                <div class="nav-tabs-inverse">
                    <ul class="nav nav-tabs nav-tabs-solid" data-plugin="nav-tabs" role="tablist">
                        <li class="active" role="presentation">
                            <a data-toggle="tab" href="#profile-tab" aria-controls="current" role="tab" aria-expanded="true">Профиль</a>
                        </li>
                        {% if is_editing_allowed %}
                            <li role="presentation">
                                <a href="{{ profile_user.get_update_profile_url }}"><i class="fa fa-cog"></i> {% trans "Edit" %}</a>
                            </li>
                        {% endif %}
                        {% if user.is_curator %}
                            <li role="presentation">
                                <a href="#for-curator-tab" role="tab" data-toggle="tab">
                                    <i class="fa fa-user-secret"></i> Для куратора
                                </a>
                            </li>
                            {% if profile_user.is_student or profile_user.is_volunteer or profile_user.is_graduate %}
                                <li role="presentation">
                                    <a href="#student-assignments-tab" role="tab" data-toggle="tab">
                                        <i class="fa fa-list"></i>&nbsp;Задания
                                    </a>
                                </li>
                            {% endif %}
                        {% endif %}
                    </ul>
                </div>
            {% endif %}
        </div>

        <div class="profile-content tab-content">
            {% if user.is_curator %}
                <div class="tab-pane" role="tabpanel" id="for-curator-tab">
                    <table class="table table-condensed table-striped">
                        <tr>
                            <td>{% trans "Phone" %}:</td>
                            <td>{{ profile_user.phone|default:"—" }}</td>
                        </tr>
                        <tr>
                            <td>{% trans "Email" %}:</td>
                            <td>
                                {{ profile_user.email }}
                            </td>
                        </tr>
                        <tr>
                            <td>{% trans "Workplace" %}:</td>
                            <td>{{ profile_user.workplace|default:"—" }}</td>
                        </tr>
                        <tr>
                            <td>Группы</td>
                            <td>
                                {% for group in profile_user.site_groups %}
                                    {{ group.get_role_display }}{% if not forloop.last %}<br>{% endif %}{% empty %}нет указанных групп
                                {% endfor %}
                            </td>
                        </tr>
                        <tr>
                            <td>Успешно сдано курсов</td>
                            <td>
                                 {{ stats.passed.total }}
                            </td>
                        </tr>
                        <tr>
                            <td>Записей за семестр [{{ current_semester }}]</td>
                            <td>{{ stats.in_term.total }} (на курсы Клуба/Центра/ШАД)</td>
                        </tr>
                        <tr>
                            <td>Анкеты</td>
                            <td>
                                {% for applicant in profile_user.applicant_set.all %}
                                    <a target="_blank" href="{{ applicant.get_absolute_url }}">#{{ applicant.pk }}</a>{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    Анкеты не найдены
                                {% endfor %}
                            </td>
                        </tr>
                        <tr>
                            <td>Социальные сети</td>
                            <td>
                                {{ profile_user.social_networks|default_if_none:"-" }}
                            </td>
                        </tr>
                        <tr>
                            <td>Anytask</td>
                            <td>{% if profile_user.anytask_url %}
                                <a href="{{ profile_user.anytask_url }}" target="_blank" rel="noopener">{{ profile_user.anytask_url }}</a>
                            {% else %}
                                —
                            {% endif %}
                            </td>
                        </tr>
                    </table>

                    {% with borrows=profile_user.borrows.all %}
                        <h4 class="_mtop-30">{% trans "books" %}:</h4>
                        {% if borrows %}
                            <ul>
                                {% for borrow in borrows %}
                                    <li>
                                        <a href="{{ borrow.stock.get_absolute_url }}">{{ borrow.stock.book.title }}</a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            Нет одолженных книг.
                        {% endif %}
                    {% endwith %}

                    {% if student_profile %}
                        <h4 class="_mtop-30">{% trans "Student references" %}:</h4>
                        {% if student_profile.certificates_of_participation.all %}
                            <ul>
                                {% for reference in student_profile.certificates_of_participation.all %}
                                    <li>
                                        <a target="_blank" href="{{ reference.get_absolute_url }}">{{ reference.created|date:"d.m.Y" }}</a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        <a href="{% url 'student_reference_add' subdomain=LMS_SUBDOMAIN student_profile_id=student_profile.pk %}" class="btn btn-primary btn-outline">{% trans "Create reference" %}</a>
                    {% endif %}

                    {% if student_profile %}
                        <h4 class="_mtop-30">{% trans "Student info record" %} <small><a href="{% url 'admin:users_studentprofile_change' object_id=student_profile.pk %}" target="_blank"><i class="fa fa-pencil-square-o"></i></a></small></h4>
                        <table class="table table-condensed table-striped">
                            <tr>
                                <td>Отделение</td>
                                <td>{{ student_profile.branch }}</td>
                            </tr>
                            <tr>
                                <td>Статус</td>
                                <td>{{ student_profile.get_status_display|default:"—" }}</td>
                            </tr>
                            <tr>
                                <td width="25%">{% trans "University" %}:</td>
                                <td>{{ student_profile.university|default:"—" }}</td>
                            </tr>
                            <tr>
                                <td>{% trans "StudentInfo|University year" %}:</td>
                                <td>
                                    {{ student_profile.get_level_of_education_on_admission_display|default:"—" }}</td>
                            </tr>
                            <tr>
                                <td>{% trans "Curriculum year" %}:</td>
                                <td>
                                    {{ student_profile.year_of_curriculum|default:'—' }}<br>
                                    {% if syllabus %}
                                        {% for program in syllabus %}
                                            <b>{{ program.academic_discipline.name_en }}</b>
                                            {% if program.course_groups.all %}
                                            <ul style="list-style-type: square;">
                                                {% for meta_course_groups in program.course_groups.all %}
                                                    <li>
                                                        {% for meta_course in meta_course_groups.courses.all %}
                                                            {# Syllabus contains center courses only #}
                                                            {% if meta_course.id in stats.passed.center_courses or meta_course.id in stats.passed.club_courses %}
                                                                <span class="text-success">{{ meta_course.name }}</span>
                                                            {% elif meta_course.id in stats.in_term.courses %}
                                                                <span class="text-info">{{ meta_course.name }}</span>
                                                            {% else %}
                                                                {{ meta_course.name }}{% endif %}
                                                            {% if not forloop.last %}{% if meta_course_groups.courses.all|length > 2 %},{% endif %} или {% endif %}
                                                        {% endfor %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                        {% endfor %}
                                        <br>Обозначения: <span class="text-success">зелёный</span> - курс сдан / <span class="text-info">синий</span> - запись в текущем семестре<br>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>{% trans "Comment" %}:</td>
                                <td>
                                    <div class="ubertext">
                                        {% markdown 3600 "user_comment" profile_user.pk profile_user.modified %}
                                            {{ profile_user.comment|default:"—" }}
                                        {% endmarkdown %}
                                    </div>
                                    {% if profile_user.comment %}
                                        <span class="student-comment-metainfo pull-right">
                                            {% if profile_user.comment_last_author_id %}{{ profile_user.comment_last_author.get_short_name }}, {% endif %}
                                            {{ profile_user.comment_changed_at|date:"d.m.Y H:i" }}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    {% endif %}
                </div>

                {% if profile_user.is_student or profile_user.is_volunteer or profile_user.is_graduate %}
                    <div class="tab-pane" role="tabpanel" id="student-assignments-tab">
                        {% if assignments %}
                            <h4 class="_mtop-30">{% trans "Assignments" %}:
                                <div class="btn-group pull-right assignment-list-control"
                                     role="group">
                                    <button type="button"
                                            class="btn btn-xs btn-default active current-semester">{{ current_semester }}</button>
                                </div>
                            </h4>
                            <table class="table table-condensed" id="assignments-table">
                                <tr>
                                    <th>{% trans "Course offering" %}</th>
                                    <th>{% trans "Assignment" %}</th>
                                    <th>{% trans "Grade" %}</th>
                                </tr>
                                {% regroup assignments by assignment.course_id as student_assignments_by_course %}
                                {% for student_assignments in student_assignments_by_course %}
                                    {% for a_s in student_assignments.list %}
                                        <tr>
                                            <td>
                                                {% if forloop.first %}
                                                    <a href="{{ a_s.assignment.course.get_absolute_url }}">{{ a_s.assignment.course }}</a>
                                                {% else %}
                                                    <span style="color: #CCC">—〃—</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ a_s.get_teacher_url }}">
                                                    {{ a_s.assignment.title }}
                                                </a>
                                            </td>
                                            <td>
                                        <span style="white-space: nowrap;"
                                              class="badge assignment-status {{ a_s.state.css_class }}">
                                          {{ a_s.state_display }}
                                        </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                            </table>
                        {% else %}
                            Список заданий пуст.
                        {% endif %}
                    </div>
                {% endif %}
            {% endif %}

            <div class="tab-pane active" role="tabpanel" id="profile-tab">
                <ul class="list-unstyled">
                    {% if profile_user.enrollment_set.all or profile_user.shadcourserecord_set.all %}
                        <li>
                            <h4>{{ profile_user.first_name }} {% if profile_user.gender == 'F' %}прослушала и сдала{% else %}прослушал и сдал{% endif %} следующие курсы:</h4>
                            <ul>
                                {% for enrollment in profile_user.enrollment_set.all %}
                                    <li>
                                        <a href="{{ enrollment.course.get_absolute_url }}">{{ enrollment.course }}</a> /{{ enrollment.grade_honest|lower }}/
                                    </li>
                                {% endfor %}
                                {% for shad in profile_user.shadcourserecord_set.all %}
                                    <li>
                                        {{ shad.name }} (ШАД), {{ shad.semester }} - {{ shad.teachers }} /{{ shad.grade_display|lower }}/
                                    </li>
                                    {% empty %}
                                    {% if user.is_curator %}<li>Нет зачтённых ШАД-курсов</li>{% endif %}
                                {% endfor %}
                            </ul>
                        </li>
                    {% endif %}

                    {% if student_projects %}
                        <li>
                            <h4>Кроме того, участвовал{% if profile_user.gender == 'F' %}а{% endif %} в проектах:</h4>
                            <ul>
                                {% for ps in student_projects %}
                                    <li>
                                        {% if user.is_authenticated %}<a href="{{ ps.project.get_absolute_url }}">{% endif %}{{ ps.project.name }}, {{ ps.project.semester }}{% if user.is_authenticated %}</a>{% endif %} /{% spaceless %}
                                        {% if ps.project.status is None %}
                                            {{ ps.final_grade_display|lower }}
                                        {% elif ps.project.status == ps.project.Statuses.CONTINUED %}
                                            {% trans "Shifted"|lower context "Project" %}
                                        {% elif ps.project.is_canceled %}
                                            {% trans "Canceled"|lower context "Project" %}
                                        {% endif %}
                                        {% endspaceless %}/<br>
                                    </li>
                                {% endfor %}
                            </ul>
                        </li>
                        {% elif user.is_curator %}
                        <li>Нет студенческих проектов</li>
                    {% endif %}

                    {% if profile_user.pk == user.pk or user.is_curator %}
                        {% with recs=profile_user.onlinecourserecord_set.all %}
                            {% if recs %}
                                <li>
                                    <h4>{% trans "Online courses" %}</h4>
                                    <ul>
                                        {% for rec in recs %}
                                            <li>
                                                {% if rec.url %}
                                                    <a href="{{ rec.url }}">{{ rec.name }}</a>
                                                {% else %}
                                                    {{ rec.name }}
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% elif user.is_curator %}
                                <li>Нет зачтённых онлайн-курсов</li>
                            {% endif %}
                        {% endwith %}
                    {% endif %}

                    {% if profile_user.is_teacher %}
                        <li>
                            {% if profile_user.teaching_set.all %}
                            <h4>Преподаватель курсов:</h4>
                            <ul class="">
                                {% for courseoffering in profile_user.teaching_set.all %}
                                    <li>
                                        <a href="{{ courseoffering.get_absolute_url }}">{{ courseoffering }}</a>
                                    </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </li>
                    {% endif %}
                </ul>

                {% if profile_user.pk == user.pk %}
                    <table class="table calc table-condensed table-striped">
                        <thead>
                        <tr>
                            <th width="25%">{% trans ".iCal calendar" %}</th>
                            <th>{% trans "Link" %}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>{% trans "Classes" %}:</td>
                            <td>
                                <input type="text" value="{% url 'user_ical_classes' pk=user.pk %}" disabled="disabled">
                            </td>
                        </tr>
                        <tr>
                            <td>{% trans "Assignments" %}:</td>
                            <td>
                                <input type="text" value="{% url 'user_ical_assignments' pk=user.pk %}" disabled="disabled">
                            </td>
                        </tr>
                        <tr>
                            <td>{% trans "Events" %}:</td>
                            <td>
                                <input type="text" value="{% url 'ical_events' subdomain=LMS_SUBDOMAIN %}" disabled="disabled">
                            </td>
                        </tr>
                        </tbody>
                    </table>
                {% endif %}

                {% if user.is_authenticated %}
                    <div class="accounts">
                        <h4>{% trans "Social accounts" %}</h4>
                        <table class="table table-condensed table-striped">
                            <tr>
                                <td>Yandex</td>
                                <td>{{ profile_user.yandex_login|default:"—" }}</td>
                            </tr>
                            <tr>

                                <td>Github</td>
                                <td>{% if profile_user.github_login %}
                                    <a href="https://github.com/{{ profile_user.github_login }}"
                                       target="_blank">{{ profile_user.github_login }}</a>
                                {% else %}
                                    —
                                {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Stepik</td>
                                <td>{% if profile_user.stepic_id %}
                                    <a href="https://stepik.org/users/{{ profile_user.stepic_id }}"
                                       target="_blank">{{ profile_user.stepic_id }}</a>
                                {% else %}
                                    —
                                {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                {% endif %}

                {% if user.is_authenticated and profile_user.private_contacts.strip %}
                    <div class="contact-info">
                        <h4>{% trans "Contact information" %}:</h4>
                        <div class="ubertext">
                            {% markdown 3600 "user_private_contacts" profile_user.pk profile_user.modified %}
                                {{ profile_user.private_contacts }}{% endmarkdown %}
                        </div>
                    </div>
                {% endif %}
            </div>

        </div>
    </div> {# div#profile #}


    {% include "users/_user_detail_upload_photo.html" %}
{% endblock content %}


