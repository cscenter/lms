### Детали реализации

Поддерживаются только email-нотификации. Хранятся они сейчас в разных моделях без общего интерфейса:

1. learning.AssignmentNotification:
    is_about_passed - новое решение
    is_about_creation - создано задание (для студента)
    is_about_deadline - изменился дедлайн

2. learning.CourseNewsNotification:
    создана новость к курсу

3. post_office.Email:
    Стороннее приожение для рассылок. Активно используется для Набора.

4. notification.Notification:
    Уведомления в формате Atom Syndication Format, сейчас используется только для уведомлений о проектах
    Не уверен, что этот формат нам нужен ( is a data format used for providing users with frequently updated content - типа замена RSS). Она подразумевает feed, в котором кто-то что-то делает, но у нас по факту обычно нет actor'а

Есть 3 команды, отправляющие письма по расписанию:

* send_notification - отправляет все письма из notification.Notification. Сейчас содержит только уведомления о проектах CS центра.
* send_queued_mail - для отправки писем приложения post_office, все письма в качестве бэкенда используют `django_ses.SESBackend`
* notify - отправка уведомлений, связанных с моделями AssignmentNotification и CourseNewsNotification. 
Т.к. уведомления не связаны с конкретным сайтом, то полагаться на настройки приложения при отравке мы не можем, а значит нужно хранить smtp-настройки уже в БД и брать их динамически в зависимости от сайта, с которым связан студент.
(Например, с сайта ШАД может быть попытка отправить письмо студенту CS центра, который записан на курс ШАД, т.е. отправлять нужно с ящика центра и ссылки должны вести на сайт центра, т.к. скорее всего он записывался именно через сайт CS Центра. 
А если использовать SMTP-настройки приложения ШАД, то письмо уйдёт с yandexdataschool.ru и все ссылки будут на этот домен).
Настройки smtp-соединения для сайтов хранятся в модели SiteConfiguration

P.S. projects_notification - неудачное название, только генерирует напоминания о начале/окончании периода отправки отчетов, письма складываются в модель notification.Notification
    
    
Issues:
* подтверждение email может скручивать рейтинг сервиса. Оставить на SMTP?
* 


# Нотификации

Уведомления отправляются только по email, отправка по cron с задержкой 5 минут. 
Тело сообщения генерируется в момент отправки. Для части сообщений используется Atom Syndication Format (как на github). 
Физически уведомления хранятся в разных таблицах БД, у каждой свой формат.
Непрочитанные уведомления удаляются в ручном режиме, срок хранения обычно не превышает семестр, если поточнее, то до первой жалобы "не могу сбросить счетчик уведомления".
Прочитанные уведомления удаляются по крону раз в неделю.

Почти все нотификации принудительные, пользователь самостоятельно настроить необходимые ему события не может.

Куратор может повлиять только на уведомления преподавателя о новых комментариях к заданию. 

Схема работы следующая:

У каждого **задания** есть настройки уведомлений, где указывается список пользователей, которые будут получать нотификации о новых комментариях.
В настройках **прочтения курса** при добавлении преподавателя можно установить чекбокс "Автоматически подписывать на уведомления".
Тогда в момент создания задания (и только тогда) все преподаватели, у кого установлен этот чекбокс, будут скопированы в настройки уведомлений нового задания.
Если преподаватель был добавлен после создания задания и хочет получать уведомления, его нужно добавить в настройки уведомлений уже вручную.

Неочевидный момент: Если преподаватель не подписан на уведомления о задании, то он не увидит его на странице заданий.


## Типы уведомлений

#### Новость о курсе

Отправляется всем студентам, подписанным на курс, а также всем преподавателям курса.

#### Новое задание

Уведомление получат только студенты, подписанные на курс.

#### Изменение дедлайна задания

Уведомление получат только студенты, подписанные на курс.

#### Новый комментарий к заданию

Если комментарий от преподавателя, то уведомление ожидаемо получит только студент.

Если комментарий оставил студент, то логику отправки смотреть [здесь](https://cscenter.myjetbrains.com/youtrack/articles/LMS-A-1/).

#### Начало отчетного периода по сдаче проектов

За 3 дня до начала отчетного периода, студенты, чей проект не был отменен и кто не успел получить отрицательный балл, получат уведомление.
Повторное напоминание о том, что скоро наступит дедлайн записи, будет отправлено за 1 день до окончания.

#### Отправлен новый отчет по проекту

Уведомление получат все пользователи, у которых выставлена группа `Куратор проектов`

#### Новый комментарий к отчету по проекту

Уведомление получают 3 группы: автор отчета (он же студент), кураторы проектов и проверяющие, подписанные на связанный с отчетом проект.

Кураторы проектов и студент всегда получают уведомления о новых комментариях. 

Проверяющие получают уведомления о новых комментариях только если текущий статус отчета - "Проверка".

#### Добавлен опрос к курсу

Уведомление генерируется в момент публикации опроса (должен быть выставлен соответствующий статус), получатели - только студенты, подписанные на курс. 

## Отправка уведомлений об активности студента в задании

Получит преподаватель уведомление или нет, зависит от трёх факторов:
* Настройки уведомлений преподавателя (куратор может отключить все уведомления в настройках курса)
* Если у персонального задания указан проверяющий, все уведомления будет получать только он
* При создании задания выбранный режим ответственного определит как будет формироваться список ответственных преподавателей, которые станут получателями уведомлений

Проверяющий может быть назначен двумя способами:
* вручную в любой момент
* автоматически в момент первой активности студента (новый комментарий или новое решение), если длина сформированного списка ответственных преподавателей равна "1"

TODO: можно поддержать список watchers для всех желающих отслеживать активность проверки задания. Например, куратор подписывается на обновления проблемного студента.

### Описание режимов отвественного

Тип режима отвественного указывается в настройках задания и учитывается, только если не назначен проверяющий.

# TODO: описать режимы


### Send test email
