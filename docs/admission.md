## Введение

На 14.03.17 данные анкет собираются с помощью сервиса Яндекса.
В `learning.admission.views` есть недоделанный(!) wizard для анкеты,
который должен был заменить яндексовую форму, но сделать это пока невозможно,
т.к. у Яндекс.Контеста нет API на регистрацию сторонних пользователей.
(руками регистрировать на контест 900 человек никто не хочет).
К следующему набору вполне возможно получится его внедрить, если будет API.

# FIXME: Сейчас отправка писем для теста зависит от записанных значений passing_score, а не от статуса, как для экзамена. Нужно сделать единообразно

## Порядок действий (кратко)

* `applicants_step0` - импортируем анкеты из feedback.csv
* `applicants_step1` - находит и выводит дубликаты в анкетах, устраняем их вручную.
* `test_import_step1` - Если уже нет дубликатов, то импортируем результаты теста (только обновляем существующие записи, сохраняем наименьший результат больший 0)
* `test_import_step2` - узнаём проходной балл, затем создаём записи об экзамене для всех, у кого балл за тест >= passing_score. Для успешно сдавших рандомно проставляем contest id из переданного списка.
* `test_export_for_contest` - печатаем список логинов, успешно сдавших тест. Их вручную добавят в нужные контесты
* `test_email_results` - когда все добавлены в нужные контесты, отправляем сообщения о результатах прохождения теста
* `exam_import_step1` - сливаем результаты экзамена и файл с результатами ручной проверки некоторых заданий
* `exam_import_step2` - импортируем результаты экзамена
* `exam_email_contest_checked` - сообщим, что ручная проверка некоторых заданий завершена.
* `exam_import_step3` - проставляем статусы анкетам, на основе которых можно потом отправить письма с результами. Часть анкет придётся проверить вручную.
* -- Ручная допроверка анкет и выставление статусов --
* `exam_email_results` - email с приглашением на интервью или отказом тем, для кого уже можно ответить, будут их приглашать или нет


## Порядок импорта данных

### Импорт анкет
* Присылают csv с результатами всех анкет. Импортируем их с помощью скрипта
`applicants_step0.py`, предварительно добавив в него столбец uuid для upsert'a записей.
Коллизии крайне маловероятны, но тем не менее попытка снизить их эффект
до невероятно маловероятных есть, так что можно не беспокоиться о них (нет)

    До импорта проверить следующие моменты:
    * удалить пустые записи, если вдруг имеются
    * `headers`, если изменились заголовки или добавились новые - обновить метод.
    Поля, специфичные для города делаем с префиксом города (например, spb_university, nsk_university)
    * `course_values`. Названия из анкеты для курсов должны совпадать с названиями в БД сайта.
    FIXME: Совпадают ли названия университетов???
    * `before_import_row`, вся кастомная логика по очистке данных лежит там.

* Теперь нужно избавиться от дублей, если пользователь по какой-то причине
несколько раз заполнил анкету, такое вполне возможно.
Уникальность анкеты в рамках текущих кампаний мы определяем по яндекс логину,
указанному пользователем вручную.
Запускаем `applicants_step1.py`, передав ему список текущих кампаний и поле,
которое мы считаем содержит уникальный в рамках переданных кампаний идентификатор.
Смотрим на результаты работы скрипта, вручную разбираемся, какую анкету оставить.

### Результаты теста

*  `test_import_step1.py` должен непосредственно импортировать результаты.
Мы можем на этапе импорта указать passing_score, чтобы выставить
статус "Отказ по результатам теста" анкетам с баллом ниже указанного значения.
Но на данном этапе может пока и не быть известен passing_score, поэтому можно
уже позже воспользоваться командой `exam_import_step3`,
которая в том числе приведёт в порядок статус анкет, которые не прошли по
результатам теста.
* Следующим шагом запускаем `test_import_step2`, он создаст записи
результатов экзамена для всех анкет, которые были найдены в файле.
В дальнейшем мы будем только обновлять их.
Здесь null вполне себе подходит - не все дошли до экзамена и о нулевом
результате не всегда есть смысл рассуждать, т.е. строки, для которых мы не
нашли анкету, мы просто пропускаем. Записи эти нужно создать до отправки
результатов теста, т.к. они содержат ссылки на контест.
* Отправить уведомления о результах теста с помощью `test_email_results`

### Результаты экзамена
На этом этапе уже надо разделять по campaign_id, потому что все этапы могут завершаться в разное время, а именно:
    * ручная проверка контеста => все этапы импорта надо проводить отдельно
    *
* На этапе импорта результатов экзамена у нас уже должны быть исправлены все
яндекс логины, коллизий при поиске анкет не должно быть
(1 яндекс логин == 1 анкета в 1 городе)
Часть экзамена проверяется вручную. Яндекс.Контест
выставляет заданиям максимальный балл, если они пройдены, например, задача на
программирование пройдена, но если проверить вручную, то там плохая
асимптотика и на большем сете данных решение завалилось бы, поэтому
максимальный балл можно бы и не ставить. Произвести корректировку сейчас
помогает скрипт `exam_import_step1`, можно его настроить и сформировать
корректный csv, который потом использовать для импорта.

* Импорт результатов экзамена, команда `exam_import_step2`.
* Сначала отправить уведомление о результатах проверки контеста
* Когда ручная проверка будет завершена - `exam_import_step3` для обновления статусов, а дальше `exam_email_results`




