## Введение

На 14.03.17 данные анкет собираются с помощью сервиса Яндекса.
В `learning.admission.views` есть недоделанный(!) wizard для анкеты,
который должен был заменить яндексовую форму, но сделать это пока невозможно,
т.к. у Яндекс.Контеста нет API на регистрацию сторонних пользователей.
(руками регистрировать на контест 900 человек никто не хочет).
К следующему набору вполне возможно получится его внедрить, если будет API.

# FIXME: Сейчас отправка писем для теста зависит от записанных значений passing_score, а не от статуса, как для экзамена. Нужно сделать единообразно
## Порядок импорта

* `stage1_applicants_step0_attach_uuid` - модифицируем исходный feedback.csv, добавив к нему столбец с uuid. 
Можно пропустить этот шаг и импортировать feedback.csv в dry-run режиме, пока не исчезнут все ошибки
* `stage1_applicants_step1_import` - импортируем анкеты из feedback.csv
* `stage1_applicants_step2_duplicates` - находит и выводит дубликаты в анкетах, устраняем их вручную.
* `stage2_test_step1_import` - Если уже нет дубликатов, то импортируем результаты теста (сохраняем наименьший результат)
* -- Вбиваем все контесты в БД, необходимо для следующего шага. Вносим в настройки кампании проходной балл за тест --
* `stage2_test_step2_rejected` - выставляем статус "Отказ по результатам теста" тем, кто точно ниже проходного балла, рассылаем им сообщение с отказом.
* `stage2_test_step3_exam_records` - создаём записи об экзамене для всех, у кого балл за тест >= passing_score. Для успешно сдавших рандомно проставляем contest id.
* `stage2_test_step3_export_for_contest` - печатаем список логинов, успешно сдавших тест.
* -- Добавляем логины успешно сдавших тест в контесты --
* `stage2_test_step4_passed` - Всех недовольных результатами теста уже пофиксили к этому моменту. Отправляем инструкцию тем, кто прошёл на следующей этап-экзамен, выставляем статус "Допущен до экзамена"
* `stage3_exam_step1_email_contest_checked` - сообщим, что ручная проверка некоторых заданий завершена.
* `stage3_exam_step2_import` - импортируем результаты экзамена
* `stage3_exam_step4_statuses` - проставляем статусы анкетам, на основе которых можно потом отправить письма с результами. Часть анкет придётся проверить вручную.
* -- Ручная допроверка анкет и выставление статусов --
* `stage3_exam_step5_email_results` - email с приглашением на интервью или отказом тем, для кого уже можно ответить, будут их приглашать или нет
* `stage4_interview_email_results` - после всех интервью рассылка о результатах


## Замечания по импорту

### Импорт анкет

* Присылают csv с результатами всех анкет. Импортируем их с помощью скрипта
`stage1_applicants_step1_import.py`, предварительно добавив в него столбец uuid для upsert'a записей.
Коллизии крайне маловероятны, но тем не менее попытка снизить их эффект
до невероятно маловероятных есть, так что можно не беспокоиться о них (нет)

    До импорта проверить следующие моменты:
    * удалить пустые записи, если вдруг имеются
    * `headers`, если изменились заголовки или добавились новые - обновить метод.
    Поля, специфичные для города делаем с префиксом города (например, spb_university, nsk_university)
    * `course_values`. Названия из анкеты для курсов должны совпадать с названиями в БД сайта.
    FIXME: Совпадают ли названия университетов???
    * `before_import_row`, вся кастомная логика по очистке данных лежит там.

* Теперь нужно избавиться от дублей, если пользователь по какой-то причине
несколько раз заполнил анкету, такое бывает.
Уникальность анкеты в рамках текущих кампаний мы определяем по яндекс логину,
указанному пользователем вручную.
Запускаем `stage1_applicants_step2_duplicates.py`, передав ему поле,
которое мы считаем содержит уникальный в рамках переданных кампаний идентификатор.
По-умолчанию это yandex_login.
Смотрим на результаты работы скрипта, вручную разбираемся, какую анкету оставить.

### Результаты теста

* На этапе импорта результатов теста у нас уже должны быть исправлены все
яндекс логины, коллизий при поиске анкет не должно быть
(1 яндекс логин == 1 анкета в 1 городе)
*  `stage2_test_step1_import.py` должен непосредственно импортировать результаты.
* Следующим шагом запускаем `stage2_test_step2_exam_records`, он создаст записи
результатов экзамена для всех анкет, которые были найдены в файле.
В дальнейшем мы будем только обновлять их.
Записи эти нужно создать до отправки результатов теста, т.к. они
содержат случайно выданный id контеста из пула айдишников.

### Результаты экзамена

Часть экзамена проверяется вручную. Яндекс.Контест
выставляет заданиям максимальный балл, если они пройдены, например, задача на
программирование пройдена, но если проверить вручную, то там плохая
асимптотика и на большем сете данных решение завалилось бы, поэтому
максимальный балл можно бы и не ставить. Произвести корректировку сейчас
помогает скрипт `stage3_exam_step1_merge_csv`, можно его настроить и сформировать
корректный csv, который потом использовать для импорта.


```text
Как импортировать результаты онлайн теста:
Добавить поля `yandex_login` и `score`. Это минимум.
По `yandex_login` и указанному в консоли `campaign_id` будет найден id поступающего.
Дополнительно можно указать `created` и `stepic_id`.
Все остальные поля будут собраны и упакованы в поле `details`.
Пример заголовков csv-файла:
yandex_login,"Задача 1(Предел функции)","Задача 2(Площадь фигуры)","score"
Обязательно нужно удалять из csv-файла нерелевантные столбцы, которые будут
упакованы в `details` по ошибке и повлияют на score!
По дополнительным полям мы пытаемся определить, была ли попытка сдачи контеста, если score=0.
Если попытки были, то там 100% будет стоять "-1", т.е. значение доп. поля будет непустым
и можно с уверенностью сказать, что человек что-то пытался делать и отправлял решения.
Если он просто зашёл в контест посмотреть задания - такие ситуации, увы, нельзя отследить.
```
