{% extends "base.html" %}
{% load i18n %}
{% load core_tags %}
{% load staticfiles %}

{% block body_class %} gray{% endblock body_class %}

{% block stylesheets %}
     <link href="{% static "css/vendor/c3.min.css" %}" rel="stylesheet">
     <link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/css/bootstrap-select.min.css" rel="stylesheet">
{% endblock stylesheets %}

{% block javascripts %}
    <script charset="utf-8">
        var json_data = jQuery.parseJSON('{{ json_data|escapejs }}');
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/js/bootstrap-select.min.js" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/js/i18n/defaults-ru_RU.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="{% static "js/vendor/c3.min.js" %}"></script>
    <script src="{% static 'js/urls/reverse.js' %}"></script>
    <script type="text/javascript" src="{% static "js/stats.bundle.js" %}"></script>

    <script type="text/template" id="plot-filter-gender-template">
        <label for="<%-filterId%>">Пол:</label>
        <select class="form-control selectpicker" id="<%-filterId%>" name="<%-filterId%>">
            <option value="">-----</option>
            <option value="M">Мужской</option>
            <option value="F">Женский</option>
        </select>
    </script>
    <script type="text/template" id="plot-filter-is-online-template">
        <label for="<%-filterId%>">Способ сдачи:</label>
        <select class="form-control selectpicker" id="<%-filterId%>" name="<%-filterId%>">
            <option value="">-----</option>
            <option value="true">Через сайт</option>
            <option value="false">Другой способ</option>
        </select>
    </script>
    <script type="text/template" id="plot-filter-curriculum_year-template">
        <label for="<%-filterId%>">Год обучения:</label>
        <select class="form-control selectpicker" id="<%-filterId%>" name="<%-filterId%>">
            <option value="">-----</option>
            <% items.forEach(function(item) { %>
            <option value="<%-item%>"><%-item%></option>
            <% }); %>
        </select>
    </script>
    <script type="text/template" id="plot-filter-submit-button">
        <div class="controls">
            <button type="submit" name="update" value="Y" class="btn btn-primary btn-block">Фильтровать</button>
        </div>
    </script>
{% endblock javascripts %}

{% block content %}
<div class="container" id="stats-page">
    <h1>Статистика</h1>
    <form action="" method="GET" id="courses-filter-form">
        <div class="row">
            <div class="col-xs-3 form-group">
                <select class="form-control selectpicker" id="term-filter">
                    {% for year, group in terms %}
{#                        <optgroup label="{{ year }}">#}
                            {% for term in group %}
                                <option value="{{ term.pk }}"
                                        {% if data.selected.term_id == term.pk %}selected="selected"{% endif %}
                                        {% if courses|lookup:term.pk|length == 0 %}disabled{% endif %}>{{ term }}</option>
                            {% endfor %}
{#                        </optgroup>#}
                    {% endfor %}
                </select>
            </div>
            <div class="col-xs-7 form-group">
                <select name="course_session_id" class="form-control selectpicker" id="course-filter">
                    {% for co in courses|lookup:data.selected.term_id %}
                        <option {% if data.selected.course_session_id == co.pk %}selected="selected"{% endif %} value="{{ co.pk }}">{{ co.course__name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-xs-2 form-group">
                <div class="controls">
                    <button disabled type="submit" name="update" value="Y" class="btn btn-primary btn-block">Пересчитать</button>
                </div>
            </div>
        </div>
    </form>

    <div class="panel">
        <div class="panel-body">
            <h3>Слушатели курса</h3>
            <div class="row">
                  <div class="col-xs-6">
                      <div id="plot-participants-by-group"></div>
                  </div>
                  <div class="col-xs-6">
                      <div id="plot-participants-by-year"></div>
                  </div>
            </div>
            <h3>Задания</h3>
            <h5>Сдача заданий</h5>
            <div class="row">
                <div class="col-xs-10">
                    <div id="plot-assignments-progress"></div>
                </div>
                <div class="col-xs-2"></div>
            </div>
            <div class="alert alert-warning" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                Сейчас график распределения по годам строится на основе таблицы "Записи на курсы".<br>
                Поскольку я ещё не делал рефакторинг (чтобы не удалялись записи из этой таблицы, а делались неактивными, если студент отписался),
                то может возникнуть ситуация, когда в фильтре по годам обучения есть год 2012, а в круговой диаграмме выше его нет.
            </div>

            <h5>Время до дедлайна</h5>
            <div class="row">
                <div class="col-xs-10">
                    <div id="plot-assignments-deadline"></div>
                </div>
                <div class="col-xs-2"></div>
            </div>
            <div class="alert alert-danger" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                TODO (wtf): Бага в с3js. Если отключить что-то в легенде, то поменяется порядок.
                Если после этого нажать "Фильтр", то порядок колбэков восстановится, а отображение (цвет и текст) нет!
                Попробовать загружать через rows, может найду какой-нибудь workaround.
                TODO: Почему 2014й есть в списке по годам? Если после фильтрации нифига нет. Может у него тип undefined? Надо проверить.<br>
                TODO: Выпилить Object.values
            </div>

            <h5>Успеваемость</h5>
            <div class="row">
                <div class="col-xs-10">
                    <div id="plot-assignments-results"></div>
                </div>
                <div class="col-xs-2"></div>
            </div>

            <h5>Соотношение среднего балла с проходным</h5>
            <div class="row">
                <div class="col-xs-10">
                    <div id="plot-assignments-score"></div>
                </div>
                <div class="col-xs-2"></div>
            </div>

            <h3>Итоги</h3>
            <div class="row">
                <div class="col-xs-10">
                    <div id="plot-enrollments-results"></div>
                </div>
            </div>

{#            <h3>Активность преподавателей</h3>#}
            <div class="row">
                <div class="col-xs-10">
                    <div id="plot-enrollments-results"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

