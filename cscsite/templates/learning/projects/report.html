{% extends "base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load thumbnail %}
{% load core_tags %}
{% load projects_tags %}
{% load staticfiles %}

{% block hightlight_styles %}
<link href="{% static "css/vendor/highlight-styles/github.css" %}" rel="stylesheet">
{% endblock hightlight_styles %}

{% block content %}
    {% with student=report.project_student.student project=report.project_student.project %}

<div class="container" id="project-report-detail-page">

  <div class="row">
    <div class="col-xs-12">
      <h2 class="content-title">{{ project.name }}</h2>
      <hr>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-9">

    <div class="o-project-description">
        <div class="panel-heading">
            <a class="panel-title" aria-expanded="false" data-toggle="collapse" href="#project-description"><span>Цели и задачи проекта</span></a>
        </div>
        <div class="panel-collapse collapse" id="project-description" aria-expanded="false">
            <div class="panel-body">{{ project.description|default:"Описание проекта не найдено." }}</div>
        </div>
    </div>

    <div class="card">
        <div class="card-header ch-alt __report-text">Текст отчета  {% if request.user.is_curator %} <a href="{% url "admin:projects_report_change" report.pk %}" target="_blank"><i class="fa fa-pencil-square-o"></i></a>{% endif %}</div>
        <div class="card-body card-padding">
            <div class="ubertext">
            {% markdown 3600 "report_detail" report.pk report.modified %}
                {{ report.text }}
            {% endmarkdown %}
            </div>
              {% if report.file %}
              <span class="assignment-attachment"><i class="fa fa-file"></i></span> <a href="{{ report.file_url }}">{{ report.file_name }}</a>
              {% endif %}
        </div>
    </div>

        <ul class="comment-list">
            {% for comment in comments %}
            <li class="{% if comment.author == student %}student{% else %}reviewer{% endif %}">
              <div class="csc-well assignment-comment">
                <h5 class="assignment">{{ comment.author }}</h5>
                <div class="ubertext">
                  {% markdown 3600 "assignment_comment" comment.pk comment.modified %}
                    {{ comment.text }}
                  {% endmarkdown %}
                </div>
                <div class="metainfo-holder">
                  {% if comment.attached_file %}
                      <span class="assignment-attachment"><i class="fa fa-file"></i></span> <a href="{{ comment.attached_file_url }}">{{ comment.attached_file_name }}</a>

                  {% endif %}
                  <span class="metainfo pull-right">{{ comment.created|date:"d.m.Y H:i" }}</span>
                </div>
              </div>
            </li>
            {% endfor %}
        </ul>

        {% if can_comment %}
        <div class="csc-well">
            {% crispy new_comment_form new_comment_form.helper %}
        </div>
        {% endif %}

        {% if request.user.is_curator and report.status != report.SENT %}
            <h3>Проверка отчета</h3>
            <div class="panel-group">
            {% for review in reviews.all %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a class="panel-title" aria-expanded="false" data-toggle="collapse" href="#project-review-{{ review.pk }}">
                            {{ review.reviewer }} / <b>{% if review.is_completed %}Завершена{% else %}Не завершена{% endif %}</b>
                        </a>
                    </div>
                    <div class="panel-collapse collapse" id="project-review-{{ review.pk }}" aria-expanded="false">
                        <div class="panel-body -preliminary-scores">
                            {% include "learning/projects/_report_preliminary_assessment.html" %}
                        </div>
                    </div>
                </div>
            {% empty %}
                Нет оценок.
            {% endfor %}
            </div>
        {% endif %}

        {% if is_reviewer and report.review_state %}
        <a href="#review-form" data-toggle="collapse" aria-expanded="{% if has_errors %}true{% else %}false{% endif %}" class="collapse-link">Оценить работу</a>
        <div class="panel-collapse">
            <div class="{% if not has_errors %}collapse {% endif %}csc-well" id="review-form">
                {% crispy review_form %}
            </div>
        </div>
        {% elif is_reviewer and not user.is_curator and report.status != report.SENT %}
            <div class="card">
                <div class="card-header ch-alt"><h2>Ваша итоговая оценка</h2></div>
                <div class="card-body card-padding -preliminary-scores">
                    {% include "learning/projects/_report_preliminary_assessment.html" with review=own_review %}
                </div>
            </div>
        {% endif %}

        {% if can_assess %}
            {% crispy report_curator_assessment_form %}
        {% endif %}

        {% if request.user.is_curator and report.summarize_state %}
            <a href="#report-summarize-form" data-toggle="collapse" aria-expanded="false" class="collapse-link">Подвести итоги</a>
            <div class="panel-collapse">
                <div class="collapse csc-well" id="report-summarize-form">
                    {% crispy report_summary_form %}
                </div>
            </div>
        {% endif %}
    </div>

    <div class="col-xs-3">
        {% if request.user.is_curator %}
            <h5>Статус отчета</h5>
            {% crispy report_status_change %}
        {% elif is_reviewer %}
            <h5>Статус отчета</h5>
            {{ report.get_status_display }}
        {% endif %}
        <h5>{% if project.is_external %}Внешний{% else %}Внутренний{% endif %} проект</h5>
        {{ project.semester }}
        {% if is_reviewer %}
            <h5>Название проекта</h5>
            <a href="{% url 'projects:project_detail' project.pk %}">{{ project.name }}</a>
        {% endif %}
        {% if report.is_completed %}
            <h5>Суммарный балл за отчет</h5>
            {{ report.final_score }}
        {% endif %}
        {% if report.project_student.final_grade != "not_graded" %}
            <h5>Итоговая оценка</h5>
            <span style="white-space: nowrap;" class="badge assignment-status {{ report.project_student.final_grade|to_css }}">
             {{ report.project_student.get_final_grade_display }}
            </span>
        {% endif %}
        <h5>Презентации</h5>
        {% if project.supervisor_presentation or project.presentation %}
            {% if project.supervisor_presentation %}
                <a class="presentation-link" href="{{ project.supervisor_presentation.url }}"><i class="fa fa-file "></i> Презентация руководителя</a><br>
            {% endif %}
            {% if project.presentation %}
                <a class="presentation-link" href="{{ project.presentation.url }}"><i class="fa fa-file "></i> Презентация участников</a>
            {% endif %}
        {% else %}
            Не предоставлены
        {% endif %}
        <h5>{% if student.is_volunteer %}{% trans "Volunteer" %}{% else %}{% trans "Student" %}{% endif %}</h5>
        <ul class="list-unstyled o-users-vlist-with-photo">
                <li>
                    <a href="{{ student.get_absolute_url }}">
                    {% if student.photo %}
                        {% thumbnail student.photo "60x60" crop="center top" cropbox=student.photo_thumbnail_cropbox as im %}
                            <img alt="{{ student.get_full_name }}" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                        {% endthumbnail %}
                    {% else %}
                        <div class="square-photo-stub" data-toggle="tooltip" data-placement="top" title="{{ student.get_full_name }}">{{ student.first_name|slice:":1" }}{{ student.last_name|slice:":1" }}</div>
                    {% endif %}
                    {{ student.get_full_name }}
                    </a>
                </li>
        </ul>
        <h5>Проверяющие</h5>
        <ul class="list-unstyled o-users-vlist-with-photo">
            {% for reviewer in project.reviewers.all %}
                <li>
                    {% if reviewer.photo %}
                        {% thumbnail reviewer.photo "60x60" crop="center top" cropbox=reviewer.photo_thumbnail_cropbox as im %}
                            <img alt="{{ reviewer.get_full_name }}" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                        {% endthumbnail %}
                    {% else %}
                        <div class="square-photo-stub" data-toggle="tooltip" data-placement="top" title="{{ reviewer.get_full_name }}">{{ reviewer.first_name|slice:":1" }}{{ reviewer.last_name|slice:":1" }}</div>
                    {% endif %}
                    {{ reviewer.get_full_name }}
                </li>
            {% endfor %}
        </ul>
    </div>
  </div>
</div>
    {% endwith %}

    <script type="text/javascript">
{#    TODO: append instead of replace #}
        CSC.config.localStorage.hashes = {{ clean_comments_json|safe }};
    </script>
{% endblock content %}
