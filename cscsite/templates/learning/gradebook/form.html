{% extends "base.html" %}

{% load staticfiles %}
{% load i18n %}
{% load render_bundle from webpack_loader %}

{% block body_attrs %} data-init-section="gradebook"{% endblock body_attrs %}

{% block stylesheets %}
    <link href="{% static "css/vendor/fileinput/fileinput.min.css" %}" rel="stylesheet">
{% endblock stylesheets %}

{% block javascripts %}
    <script type="text/javascript" src="{% static "js/gradebook.js" %}"></script>
{#    {% render_bundle "teaching" "js" %}#}
    {% if request.user.has_access_to_gradebook_emails %}
        <script>
            $(function () {
                $('.marks-sheet-csv-link').tooltip({
                    title: "Поле email доступно только id = 865"
                })
            });
        </script>
    {% endif %}
{% endblock javascripts %}


{% block content %}
<div class="container container-wide">
  <form method="post" id="gradebook-form">{% csrf_token %}
  <div class="row">
    <div class="col-xs-12 h2-and-buttons">
      <h2>
        {% if request.resolver_match.url_name == 'markssheet_teacher' %}
        <a href="{% url 'markssheet_teacher_dispatch' %}"><span class="fa fa-angle-left"></span></a>
        {% else %}
        <a href="{% url 'staff:course_markssheet_staff_dispatch' %}"><span class="fa fa-angle-left"></span></a>
        {% endif %}
          {% trans "Marks sheet" %}<br><a class="small" href="{{ course_offering.get_absolute_url }}">{{ course_offering }}</a>
      </h2>
      <div class="btn-toolbar">
        <div class="btn-group">
          <button type="submit" class="btn btn-primary pull-right" id="marks-sheet-save">{% trans "Save" %}</button>
        </div>
        <div class="btn-group">
          <a href="{% url 'markssheet_teacher_csv' course_offering.get_city course_offering.course.slug course_offering.semester.slug %}"
             target="_blank"
             class="btn btn-default marks-sheet-csv-link" role="button" data-toggle="tooltip"><i class="fa fa-download"></i> Сохранить .csv</a>
        </div>
        <div class="btn-group">
          <a class="btn btn-default" data-toggle="dropdown"><i class="fa fa-upload"></i> Импорт <span class="caret"></span></a>
          <ul class="dropdown-menu pull-right" role="menu">
              <li role="presentation"><a href="#import-marks-csv-stepic" role="menuitem" data-toggle="modal">{% trans "By stepik.org ID" %}</a></li>
              <li role="presentation"><a href="#import-marks-csv-yandex" role="menuitem" data-toggle="modal">{% trans "By Yandex login" %}</a></li>
          </ul>
        </div>
        <div class="btn-group">
            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
              Все ведомости<span class="caret"></span>
            </button>
            <ul class="dropdown-menu pull-right scrollable-menu" role="menu" aria-labelledby="dropdownMenu1">
              {% regroup course_offering_list by semester as co_by_semester %}
              {% for cos in co_by_semester %}
              <li role="presentation" class="dropdown-header">{{ cos.grouper }}</li>
              {% for co in cos.list %}
              <li role="presentation"><a role="menuitem" tabindex="-1" href="{{ co.get_gradebook_url }}">{{ co.course }}</a></li>
              {% endfor %}
              {% endfor %}
            </ul>
        </div>
      </div>
      <hr>
    </div>
  </div>

        <div id="gradebook">
            {% if assignments %}
        	<div class="header">
                <span class="scroll left">«</span><span class="scroll right">»</span>
        	</div>
            {% endif %}

            <div id="students">
                <div class="title">{% trans "Students" %}</div>
                <div>
                    {% for student_id, row in students.items %}
                        {% with student=row.student by_assignment=row.assignments total_score=row.total final_grade=row.grade %}
                          <a class="cell{% if forloop.counter|divisibleby:2 %} even{% endif %}" href="{{ student.get_absolute_url }}" title="{{ student.username }}">
                              {% if student.last_name %}
                                  {{ student.last_name }}&nbsp;{{ student.first_name|first }}.
                              {% else %}
                                  {{ student.username }}
                              {% endif %}
                          </a>
                        {% endwith %}
                    {% endfor %}
                    <div class="cell student  gray">{% trans "Students total" %}:&nbsp;{{ students.items|length }}</div>
                </div>
            </div>

            <div id="grades">
                <div class="title">{% trans "Grades" %}</div>
                <div>
                    {% for student_id, row in students.items %}
                        {% with student=row.student by_assignment=row.assignments total_score=row.total final_grade=row.grade %}
                          <div class="cell{% if forloop.counter|divisibleby:2 %} even{% endif %}">{{ final_grade }}</div>
                        {% endwith %}
                    {% endfor %}
                    <div class="">&nbsp;</div>
                </div>
            </div>

            {% if assignments %}
            <div id="total">
                <div class="title">{% trans "Total" %}</div>
                <div>
                    {% for student_id, student in students.items %}<div class="cell{% if forloop.counter|divisibleby:2 %} even{% endif %}">{{ student.total }}</div>{% endfor %}
                    <div class="">&nbsp;</div>
                </div>
            </div>
            {% endif %}

            <div id="assignments">
                <div class="scrollable" style="width: {{ assignments_width }}px;">
                    {% for assignment_id, assignment in assignments.items %}
                        <div class="assignment" data-max="{{ assignment.header.grade_max }}">
                            <div class="title">
                                <a href="{% url 'assignment_detail_teacher' assignment.header.pk %}" title="{{ assignment.header.title }}">{{ assignment.header.title }}</a>
                            </div>
                            {% spaceless %}
                                {% for student_id, student_assignment in assignment.students.items %}
                                    {% if not student_assignment %}
                                        <div class="cell score{% if forloop.counter|divisibleby:2 %} even{% endif %}"></div>
                                    {% elif assignment.header.is_online %}
                                        <div class="cell score{% if forloop.counter|divisibleby:2 %} even{% endif %}">
                                            <a href="{% url 'a_s_detail_teacher' student_assignment.pk %}">{{ student_assignment.state }}</a>
                                        </div>
                                    {% else %}
                                        <input type="text" name="a_s_{{ student_assignment.pk }}" max="{{ assignment.header.grade_max }}" min="0" value="{{ student_assignment.grade }}" data-value="{{ student_assignment.grade }}" class="{% if forloop.counter|divisibleby:2 %} even{% endif %}">
                                    {% endif %}
                                {% endfor %}
                            {% endspaceless %}
                            <div class="meta">{{ assignment.header.grade_min }}/{{ assignment.header.grade_max }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
  </form>
</div>

{% include "learning/gradebook/_modal_stepic.html" %}
{% include "learning/gradebook/_modal_yandex.html" %}

{% endblock content %}

