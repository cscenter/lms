{% extends "base.html" %}
{% load i18n %}
{% load thumbnail %}
{% load core_tags %}
{% load staticfiles %}
{% load markdown from core_tags %}

{% block content %}
    <div id="profile">
    <header>
        <div class="thumbnail text-center">
        {% if user_object.photo %}
            {% thumbnail user_object.photo "170x238" crop="center" as im %}
            <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
            {% endthumbnail %}
        {% else %}
            <img src="{% static 'img/center/profile_no_photo.png' %}">
        {% endif %}
        </div>

        <h2>{{ user_object.first_name }} {{ user_object.patronymic }}<br>{{ user_object.last_name }}{% if has_curator_permissions %}
            <a href="{% url 'admin:users_cscuser_change' user_object.pk %}" target="_blank"><i class="fa fa-pencil-square-o"></i></a>
        {% endif %}</h2>

        {% if user_object.is_graduate %}
            <div class="progress-info">
            {% blocktrans with year=user_object.graduation_year %}graduated in {{ year }}{% endblocktrans %} ({% trans "enrolled in" %} {{ user_object.enrollment_year }})
            </div>
        {% elif user_object.is_student %}
            <div class="progress-info">
            {% trans "student"|title %}{% if user_object.enrollment_year %}, {% trans "enrolled in" %} {{ user_object.enrollment_year }}{% endif %}
            </div>
            {% elif user_object.is_teacher %}
                <div class="progress-info">
                {% trans "teacher"|title %}
                </div>
        {% endif %}
    </header>

    <div class="profile-additional-info">
        <div class="about-me">{% if user_object.note.strip %}
            <h4>{% trans "About me" %}</h4>
            <div class="ubertext">
              {% markdown 3600 "user_note" user_object.pk user_object.modified %}
                {{ user_object.note }}
              {% endmarkdown %}
            </div>{% elif user_object.pk == user.pk or user.is_curator %}
            <h4>{% trans "About me" %}</h4>
            <div class="ubertext"><p><em>Информация не указана.</em></p></div>
        {% endif %}</div>
    {% if user_object.pk == user.pk or user.is_curator %}
        <div class="nav-tabs-inverse">
            <ul class="nav nav-tabs nav-tabs-solid" data-plugin="nav-tabs" role="tablist">
            <li class="active" role="presentation">
                <a data-toggle="tab" href="#current" aria-controls="current" role="tab" aria-expanded="true">Профиль</a>
            </li>
            {% if is_editing_allowed %}
                <li role="presentation"><a href="{% url 'user_update' user_object.pk %}"><i class="fa fa-cog"></i> {% trans "Edit" %}</a></li>
            {% endif %}
            {% if user.is_curator %}{% if user_object.is_student or user_object.is_graduate %}
                <li role="presentation"><a href="{% url 'user_reference_add' user_object.pk %}" role="tab"><i class="fa fa-file-text-o"></i> {% trans "Create reference" %}</a></li>
            {% endif %}{% endif %}
            </ul>
        </div>
    {% endif %}
    </div>

    <div class="profile-content" {% if user_object.note.strip %}style="margin-top: -90px;"{% endif %}>
        {% if has_curator_permissions %}
            <div class="panel panel-default">
                <div class="panel-heading">Информация для куратора</div>
                <ul class="list-group">
                    <li class="list-group-item"><b>Статус</b>: {{ user_object.get_status_display|default:"—" }}</li>
                    <li class="list-group-item"><b>Группы</b>: {% for group in user_object.groups.all %}{% trans group.name %}{% if not forloop.last %}, {% endif %}{% empty %}нет указанных групп{% endfor %}</li>
                </ul>
            </div>
        {% endif %}

        <ul class="list-unstyled">
            {% if user_object.enrollment_year %}
                {% if user_object.enrollment_set.all %}
                <li>
                <h4>{% trans "Courses" %}</h4>
                    <ul>
                    {% for enrollment in user_object.enrollment_set.all %}
                    <li>
                      <a href="{% url 'course_offering_detail' enrollment.course_offering.course.slug enrollment.course_offering.semester.slug %}">
                        {{ enrollment.course_offering }}
                      </a>
                      ({{ enrollment.grade_honest|lower }})
                    </li>
                    {% endfor %}
                    </ul>
                </li>
                {% endif %}

                {% if student_projects %}
                <li>
                <h4>{% trans "Student projects" %}</h4>
                  <ul>
                    {% for project in student_projects %}
                    <li>
                      {{ project.semester }}:
                      «{{ project.name }}» {% if project.grade %}({{ project.get_grade_display|lower }}){% endif %} {% if project.presentation %} <a href="{{ project.presentation.url }}">{% trans "Presentation"|lower %}</a>{% endif %},
                      {% trans "StudentProject|Supervisor"|lower %} — {{ project.supervisor }}
                      {% if project.description %}
                      <div class="ubertext">
                        {% markdown 3600 "userproject_description" project.pk project.modified %}
                          {{ project.description }}
                        {% endmarkdown %}
                      </div>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                </li>
                {% elif user.is_curator %}
                    <li>Нет студенческих проектов</li>
                {% endif %}

                {% with shad_courses=user_object.shadcourserecord_set.all %}
                {% if shad_courses %}
                <li>
                    <h4>{% trans "School of Data Analysis courses" %}</h4>
                    <ul>
                      {% for shad in shad_courses %}
                      <li>{{ shad.name }} - {{ shad.teachers }} ({{ shad.grade_display }})</li>
                      {% endfor %}
                    </ul>
                </li>
                {% elif user.is_curator %}
                    <li>Нет зачтённых ШАД-курсов</li>
                {% endif %}
                {% endwith %}

                {% if user_object.pk == user.pk or user.is_curator %}
                {% with recs=user_object.onlinecourserecord_set.all %}
                {% if recs %}
                <li>
                    <h4>{% trans "Online courses" %}</h4>
                    <ul>
                      {% for rec in recs %}
                      <li>{{ rec.name }}</li>
                      {% endfor %}
                    </ul>
                </li>
                {% elif user.is_curator %}
                <li>Нет зачтённых онлайн-курсов</li>
                {% endif %}
                {% endwith %}
                {% endif %}

                {% endif %}
                {% if user_object.is_teacher %}
                <li>{% trans "teacher"|title %}{% if user_object.teaching_set.all %}:{% endif %}
                  <ul class="">
                    {% for courseoffering in user_object.teaching_set.all %}
                    <li>
                      <a href="{% url 'course_offering_detail' courseoffering.course.slug courseoffering.semester.slug %}">
                        {{ courseoffering }}
                      </a>
                    </li>
                    {% endfor %}
                  </ul>
                </li>
                {% endif %}
            </ul>

            {% if user_object.pk == user.pk %}
            <table class="table calc table-condensed table-striped">
                <thead>
                <tr>
                    <th width="25%">{% trans ".iCal calendar" %}</th>
                    <th>{% trans "Link" %}</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                  <td>{% trans "Classes" %}:</td>
                  <td>
                    <input type="text" value="http://{{ request.get_host }}{% url 'user_ical_classes' user.pk %}"
                           disabled="disabled">
                  </td>
                </tr>
                <tr>
                  <td>{% trans "Assignments" %}:</td>
                  <td>
                    <input type="text" value="http://{{ request.get_host }}{% url 'user_ical_assignments' user.pk %}"
                           disabled="disabled">
                  </td>
                </tr>
                <tr>
                  <td>{% trans "Events" %}:</td>
                  <td>
                    <input type="text" value="http://{{ request.get_host }}{% url 'ical_events' %}"
                           disabled="disabled">
                  </td>
                </tr>
                </tbody>
              </table>
            {% endif %}


            {% if user.is_authenticated %}
            <div class="accounts">
                <h4>{% trans "Social accounts" %}</h4>
                <table class="table table-condensed table-striped">
                <tr>
                    <td>Yandex</td>
                    <td>{{ user_object.yandex_id|default:"—" }}</td>
                </tr>
                <tr>

                    <td>Github</td>
                    <td>{% if user_object.github_id %}
                          <a href="https://github.com/{{ user_object.github_id }}" target="_blank">{{ user_object.github_id }}</a>
                        {% else %}
                          —
                        {% endif %}
                    </td>
                </tr>
                <tr>

                    <td>Stepic</td>
                    <td>{% if user_object.stepic_id %}
                          <a href="https://stepic.org/users/{{ user_object.stepic_id }}" target="_blank">{{ user_object.stepic_id }}</a>
                        {% else %}
                          —
                        {% endif %}
                    </td>
                </tr>
                </table>
            </div>
            {% endif %}

            {% if user_object.csc_review %}
                <div class="review">
                    <h4>{% blocktrans with name=user_object.first_name %}{{name}} about CSC{% endblocktrans %}:</h4>
                    <div class="ubertext">
                      {% markdown 3600 "csc_review" user_object.pk user_object.modified %}{{ user_object.csc_review }}{% endmarkdown %}
                    </div>
                </div>
            {% endif %}

            {% if user.is_authenticated and user_object.private_contacts.strip %}
                <div class="contact-info">
                    <h4>{% trans "Contact information" %}:</h4>
                    <div class="ubertext">
                      {% markdown 3600 "user_private_contacts" user_object.pk user_object.modified %}{{ user_object.private_contacts }}{% endmarkdown %}
                    </div>
                </div>
            {% endif %}

            {% if a_ss %}
                <h4 class="_mtop-30">{% trans "Assignments" %}:
                  <div class="btn-group pull-right assignment-list-control" role="group">
                    <button type="button" class="btn btn-xs btn-default active current-semester">{{ current_semester }}</button>
                  </div></h4>
                <table class="table table-condensed" id="assignments-table">
                  <tr>
                    <th>{% trans "Course offering" %}</th>
                    <th>{% trans "Assignment" %}</th>
                    <th>{% trans "Grade" %}</th>
                  </tr>
                  {% for a_s in a_ss %}
                    <tr>
                      <td>
                        {% if a_s.hacky_co_change %}
                          <a href="{{ a_s.assignment.course_offering.get_absolute_url }}">{{ a_s.assignment.course_offering }}</a>
                        {% else %}
                          <span style="color: #CCC">—〃—</span>
                        {% endif %}
                      </td>
                      <td>
                        <a href="{% url 'a_s_detail_teacher' a_s.pk %}">
                          {{ a_s.assignment.title }}
                        </a>
                      </td>
                      <td>
                        <span style="white-space: nowrap;"
                              class="badge assignment-status {{ a_s.state|to_css }}">
                          {{ a_s.state_display }}
                        </span>
                      </td>
                    </tr>
                  {% endfor %}
                </table>
            {% endif %}

            {% with borrows=user_object.borrows.all %}
            {% if has_curator_permissions and borrows and request.site.domain == "compscicenter.ru" %}
              <h4 class="_mtop-30">{% trans "books" %}:</h4>
              <ul>
                {% for borrow in borrows %}
                <li><a href="{{ borrow.book.get_absolute_url }}">{{ borrow.book.title }}</a></li>
                {% endfor %}
              </ul>
                {% elif has_curator_permissions and borrows %}
                <h4 class="_mtop-30">{% trans "books" %}:</h4>
                Со списком книг можно ознакомиться на сайте центра.
            {% endif %}
            {% endwith %}

            {% if user_object.is_student or user_object.is_graduate %}
            {% if has_curator_permissions %}
                <h4 class="_mtop-30">{% trans "Student info record" %}:</h4>
                <table class="table table-condensed table-striped">
                <tr>
                  <td width="25%">{% trans "University" %}:</td>
                  <td>{{ user_object.university|default:"—" }}</td>
                </tr>
                <tr>
                  <td>{% trans "Phone" %}:</td>
                  <td>{{ user_object.phone|default:"—" }}</td>
                </tr>
                {% if has_curator_permissions %}
                  <tr>
                    <td>{% trans "Email" %}:</td>
                    <td>
                      {{ user_object.email }}
                    </td>
                  </tr>
                {% endif %}
                <tr>
                  <td>{% trans "StudentInfo|University year" %}:</td>
                  <td>{{ user_object.uni_year_at_enrollment_display|default:"—" }}</td>
                </tr>
                <tr>
                  <td>{% trans "Comment" %}:</td>
                  <td>
                    <div class="ubertext">
                      {% markdown 3600 "user_comment" user_object.pk user_object.modified %}
                        {{ user_object.comment|default:"—" }}
                      {% endmarkdown %}
                    </div>
                    {% if user_object.comment %}
                    <span class="student-comment-metainfo pull-right">
                      {{ user_object.comment_last_author.get_short_name }}{% if user_object.comment_last_author %}, {% endif %}
                      {{ user_object.comment_changed_at|date:"d.m.Y H:i" }}
                    </span>
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td>{% trans "Status" %}:</td>
                  <td>
                    {{ user_object.get_status_display|default:"—" }} {% if user_object.is_volunteer %}({% trans "Non-degree student"|lower %}){% endif %}
                  </td>
                </tr>
                <tr>
                  <td>{% trans "StudentInfo|Study program" %}:</td>
                  <td>
                    {% with sps=user_object.study_programs.all %}
                    {% if sps %}
                    <ul class="list-unstyled">
                      {% for sp in sps %}
                      <li>{{ sp.name }}</li>
                      {% endfor %}
                    </ul>
                    {% else %}
                    —
                    {% endif %}
                    {% endwith %}
                  </td>
                </tr>
                <tr>
                  <td>{% trans "Workplace" %}:</td>
                  <td>{{ user_object.workplace|default:"—" }}</td>
                </tr>
              </table>
            {% endif %}
            {% endif %}

            {% if has_curator_permissions and  user_object.cscuserreference_set.count > 0 %}
            {% if user_object.is_student or user_object.is_graduate %}
                <h4 class="_mtop-30">{% trans "Student references" %}:</h4>
                  <ul>
                    {% for reference in user_object.cscuserreference_set.all %}
                    <li>
                      <a href="{% url 'user_reference_detail' user_object.id reference.id %}">
                        {{ reference.created|date:"d.m.Y" }}
                      </a>
                    </li>
                    {% endfor %}
                  </ul>
            {% endif %}
            {% endif %}

    </div>
    </div> {# div#profile #}
{% endblock content %}
