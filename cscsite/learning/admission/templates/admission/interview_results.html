{% extends "base.html" %}
{% load i18n %}
{% load bootstrap_pagination %}
{% load crispy_forms_tags %}
{% load floatdot from core_tags %}

{% block title %}Результаты набора {{ selected_campaign.city.code }} - CSC{% endblock title %}
{% block body_attrs %} class="gray"{% endblock body_attrs %}

{% block content %}
<div class="interview-results-page">
    {% crispy filter.form %}
    <div class="nav-tabs-horizontal nav-tabs-inverse">
        <ul class="nav nav-tabs nav-tabs-solid" role="tablist">
            {% for campaign in active_campaigns %}
                <li role="presentation" {% if selected_campaign.city.code == campaign.city.code %} class="active"{% endif %}>
                    <a href="{% url "admission:interview_results_by_city" campaign.city.code %}">{{ campaign }}</a>
                </li>
            {% endfor %}
        </ul>
        <div class="tab-content">
            {% if formset|length > 0 %}
                {% if not filter.data.status %}
                    <ul class="list-unstyled">
                        <li>Всего: {{ formset.total_form_count }}</li>
                    {% for status, cnt in stats %}
                        <li>{{ status }}: {{ cnt }}</li>
                    {% endfor %}
                    </ul>
                {% endif %}

                <form action="" method="post"{% if formset.is_multipart %} enctype="multipart/form-data"{% endif %} novalidate>{% csrf_token %}
                {{ formset.management_form }}
                {% if formset.errors %}
                    <p class="errornote">
                    {% if formset.total_error_count == 1 %}{% trans "Please correct the error below." %}{% else %}{% trans "Please correct the errors below." %}{% endif %}
                    </p>
                    {{ formset.non_form_errors }}
                {% endif %}

                  <table class="table">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Поступающий</th>
                        <th>Тест</th>
                        <th>Экзамен</th>
                        <th>Интервью</th>
                        <th>Итог</th>
                      </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %}
                            {% with applicant=form.instance interview=form.instance.interview %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td class="applicant">
                                    <a href="{%  url "admission:applicant_detail" applicant.pk %}">{{ applicant.get_full_name }}</a><br>
                                    {{ applicant.university }}
                                </td>
                                <td>{{ applicant.online_test.score|default:"-" }}/{{ selected_campaign.online_test_max_score }}</td>
                                <td>{{ applicant.exam.score|default:"-" }}/{{ selected_campaign.exam_max_score }}</td>
                                <td>{% if interview.status == 'completed' %}{% if interview.average_score != None %}{{ interview.average_score|floatdot:2 }}{% else %}<не найдено>{% endif %}{% else %}<span class="grey">{{ applicant.get_status_display }}</span>{% endif %}</td>
                                <td>
                                    {{ form.status }}
                                    {{ form.status.errors }}
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endwith %}
                        {% endfor %}
                    </tbody>
                  </table>
                    <button type="submit" class="btn btn-primary btn-outline">Сохранить</button>
                </form>
            {% else %}
                Измените параметры поиска, либо для выбранного набора ещё нет прошедших собеседование.
            {% endif %}
        </div>
    </div>
  </div>
{% endblock content %}
