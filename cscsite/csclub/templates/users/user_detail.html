{% extends "base.html" %}
{% load i18n %}
{% load thumbnail %}
{% load core_tags %}
{% load staticfiles %}
{% load markdown from core_tags %}
{% load render_bundle from webpack_loader %}


{% block javascripts %}
    {#  Initial data  #}
    <script type="text/javascript">
        window.profileAppInit = {{ initial|safe }};
        window.profileAppInit["preload"] = [
            "{% static "js/vendor/FileAPI/FileAPI.min.js" %}"
        ];
    </script>
    {% render_bundle 'profile' 'js' attrs='defer' %}
{% endblock javascripts %}

{% block content %}
<div class="container">
<div class="row">
<div class="col-xs-9 profile-body">
    <h2>{{ user_object.get_full_name }}</h2>
    {% if user_object.is_graduate %}
      {% blocktrans with year=user_object.graduation_year %}graduated in {{ year }}{% endblocktrans %} ({% trans "enrolled in" %} {{ user_object.enrollment_year }})
    {% elif user_object.is_student %}
        {% trans "student"|title %}{% if user_object.enrollment_year %}, {% trans "enrolled in" %} {{ user_object.enrollment_year }}{% endif %}
    {% endif %}

    {% if has_curator_permissions %}
        <br><br>
        <div class="panel panel-default">
            <div class="panel-heading panel-title">Информация для куратора</div>
            <ul class="list-group">
                <li class="list-group-item"><b>Статус</b>: {{ user_object.get_status_display|default:"—" }}</li>
                <li class="list-group-item"><b>Группы</b>: {% for group in user_object.groups.all %}{% trans group.name %}{% if not forloop.last %}, {% endif %}{% empty %}нет указанных групп{% endfor %}</li>
            </ul>
        </div>
    {% endif %}

    {% if user_object.note %}
        <div class="about-me">
            <h4>{% trans "About me" %}</h4>
            <div class="ubertext">
              {% markdown 3600 "user_note" user_object.pk user_object.modified %}
                {{ user_object.note }}
              {% endmarkdown %}
            </div>
        </div>
    {% endif %}

    <ul class="list-unstyled">
    {% if user_object.enrollment_year %}
        {% if user_object.enrollment_set.all %}
        <li>
        <h4>{% trans "Courses" %}</h4>
            <ul>
            {% for enrollment in user_object.enrollment_set.all %}
            <li>
              <a href="{% url 'course_offering_detail' enrollment.course_offering.course.slug enrollment.course_offering.semester.slug %}">
                {{ enrollment.course_offering }}
              </a>
              ({{ enrollment.grade_honest|lower }})
            </li>
            {% endfor %}
            </ul>
        </li>
        {% endif %}

        {% if student_projects %}
        <li>
        <h4>{% trans "Student projects" %}</h4>
          <ul>
            {% for ps in student_projects %}{% with project=ps.project %}
            <li>
              {{ project.semester }}:
              «{{ project.name }}» {% if ps.final_grade %}({{ ps.get_final_grade_display|lower }}){% endif %} {% if project.presentation %} <a href="{{ project.presentation.url }}">{% trans "Presentation"|lower %}</a>{% endif %},
              {% trans "StudentProject|Supervisor"|lower %} — {{ project.supervisor }}
              {% if project.description %}
              <div class="ubertext">
                {% markdown 3600 "userproject_description" project.pk project.modified %}
                  {{ project.description }}
                {% endmarkdown %}
              </div>
              {% endif %}
            </li>
            {% endwith %}{% endfor %}
          </ul>
        </li>
        {% elif user.is_curator %}
            <li>Нет студенческих проектов</li>
        {% endif %}

        {% with shad_courses=user_object.shadcourserecord_set.all %}
        {% if shad_courses %}
        <li>
            <h4>{% trans "School of Data Analysis courses" %}</h4>
            <ul>
              {% for shad in shad_courses %}
              <li>{{ shad.name }} - {{ shad.teachers }} ({{ shad.grade_display }})</li>
              {% endfor %}
            </ul>
        </li>
        {% elif user.is_curator %}
            <li>Нет зачтённых ШАД-курсов</li>
        {% endif %}
        {% endwith %}

        {% if user_object.pk == user.pk or user.is_curator %}
        {% with recs=user_object.onlinecourserecord_set.all %}
        {% if recs %}
        <li>
            <h4>{% trans "Online courses" %}</h4>
            <ul>
              {% for rec in recs %}
              <li>{{ rec.name }}</li>
              {% endfor %}
            </ul>
        </li>
        {% elif user.is_curator %}
        <li>Нет зачтённых онлайн-курсов</li>
        {% endif %}
        {% endwith %}
        {% endif %}

        {% endif %}
        {% if user_object.is_teacher %}
        <li>{% trans "teacher"|title %}{% if user_object.teaching_set.all %}:{% endif %}
          <ul class="">
            {% for courseoffering in user_object.teaching_set.all %}
            <li>
              <a href="{% url 'course_offering_detail' courseoffering.course.slug courseoffering.semester.slug %}">
                {{ courseoffering }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </li>
        {% endif %}
    </ul>

    {% if user_object.pk == user.pk %}
    <table class="table calc table-condensed table-striped">
        <thead>
        <tr>
            <th width="25%">{% trans ".iCal calendar" %}</th>
            <th>{% trans "Link" %}</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td>{% trans "Classes" %}:</td>
          <td>
            <input type="text" value="http://{{ request.get_host }}{% url 'user_ical_classes' user.pk %}"
                   disabled="disabled">
          </td>
        </tr>
        <tr>
          <td>{% trans "Assignments" %}:</td>
          <td>
            <input type="text" value="http://{{ request.get_host }}{% url 'user_ical_assignments' user.pk %}"
                   disabled="disabled">
          </td>
        </tr>
        </tbody>
      </table>
    {% endif %}

    {% if user.is_authenticated %}
    <div class="accounts">
        <h4>{% trans "Social accounts" %}</h4>
        <table class="table table-condensed table-striped">
        <tr>
            <td>Yandex</td>
            <td>{{ user_object.yandex_id|default:"—" }}</td>
        </tr>
        <tr>

            <td>Github</td>
            <td>{% if user_object.github_id %}
                  <a href="https://github.com/{{ user_object.github_id }}" target="_blank">{{ user_object.github_id }}</a>
                {% else %}
                  —
                {% endif %}
            </td>
        </tr>
        <tr>

            <td>Stepic</td>
            <td>{% if user_object.stepic_id %}
                  <a href="https://stepic.org/users/{{ user_object.stepic_id }}" target="_blank">{{ user_object.stepic_id }}</a>
                {% else %}
                  —
                {% endif %}
            </td>
        </tr>
        </table>
    </div>
    {% endif %}

    {% if user_object.csc_review %}
        <div class="review">
            <h4>{% blocktrans with name=user_object.first_name %}{{name}} about CSC{% endblocktrans %}:</h4>
            <div class="ubertext">
              {% markdown 3600 "csc_review" user_object.pk user_object.modified %}{{ user_object.csc_review }}{% endmarkdown %}
            </div>
        </div>
    {% endif %}

    {% if user.is_authenticated and user_object.private_contacts.strip %}
        <div class="contact-info">
            <h4>{% trans "Contact information" %}:</h4>
            <div class="ubertext">
              {% markdown 3600 "user_private_contacts" user_object.pk user_object.modified %}{{ user_object.private_contacts }}{% endmarkdown %}
            </div>
        </div>
    {% endif %}

    {% if a_ss %}
        <h4 class="_mtop-30">{% trans "Assignments" %}:
          <div class="btn-group pull-right assignment-list-control" role="group">
            <button type="button" class="btn btn-xs btn-default active current-semester">{{ current_semester }}</button>
          </div></h4>
        <table class="table table-condensed" id="assignments-table">
          <tr>
            <th>{% trans "Course offering" %}</th>
            <th>{% trans "Assignment" %}</th>
            <th>{% trans "Grade" %}</th>
          </tr>
          {% for a_s in a_ss %}
            <tr>
              <td>
                {% if a_s.hacky_co_change %}
                  <a href="{{ a_s.assignment.course_offering.get_absolute_url }}">{{ a_s.assignment.course_offering }}</a>
                {% else %}
                  <span style="color: #CCC">—〃—</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'a_s_detail_teacher' a_s.pk %}">
                  {{ a_s.assignment.title }}
                </a>
              </td>
              <td>
                <span style="white-space: nowrap;"
                      class="badge assignment-status {{ a_s.state|to_css }}">
                  {{ a_s.state_display }}
                </span>
              </td>
            </tr>
          {% endfor %}
        </table>
    {% endif %}

    {% with borrows=user_object.borrows.all %}
    {% if has_curator_permissions and borrows and request.site.domain == "compscicenter.ru" %}
      <h4 class="_mtop-30">{% trans "books" %}:</h4>
      <ul>
        {% for borrow in borrows %}
        <li><a href="{{ borrow.book.get_absolute_url }}">{{ borrow.book.title }}</a></li>
        {% endfor %}
      </ul>
        {% elif has_curator_permissions and borrows %}
        <h4 class="_mtop-30">{% trans "books" %}:</h4>
        Со списком книг можно ознакомиться на сайте центра.
    {% endif %}
    {% endwith %}

    {% if user_object.is_student or user_object.is_graduate %}
    {% if has_curator_permissions %}
        <h4 class="_mtop-30">{% trans "Student info record" %}:</h4>
        <table class="table table-condensed table-striped">
        <tr>
          <td width="25%">{% trans "University" %}:</td>
          <td>{{ user_object.university|default:"—" }}</td>
        </tr>
        <tr>
          <td>{% trans "Phone" %}:</td>
          <td>{{ user_object.phone|default:"—" }}</td>
        </tr>
        {% if has_curator_permissions %}
          <tr>
            <td>{% trans "Email" %}:</td>
            <td>
              {{ user_object.email }}
            </td>
          </tr>
        {% endif %}
        <tr>
          <td>{% trans "StudentInfo|University year" %}:</td>
          <td>{{ user_object.uni_year_at_enrollment_display|default:"—" }}</td>
        </tr>
        <tr>
          <td>{% trans "Comment" %}:</td>
          <td>
            <div class="ubertext">
              {% markdown 3600 "user_comment" user_object.pk user_object.modified %}
                {{ user_object.comment|default:"—" }}
              {% endmarkdown %}
            </div>
            {% if user_object.comment %}
            <span class="student-comment-metainfo pull-right">
              {{ user_object.comment_last_author.get_short_name }}{% if user_object.comment_last_author %}, {% endif %}
              {{ user_object.comment_changed_at|date:"d.m.Y H:i" }}
            </span>
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>{% trans "Status" %}:</td>
          <td>
            {{ user_object.get_status_display|default:"—" }} {% if user_object.is_volunteer %}({% trans "Non-degree student"|lower %}){% endif %}
          </td>
        </tr>
        <tr>
          <td>{% trans "StudentInfo|Study program" %}:</td>
          <td>
            {% with sps=user_object.study_programs.all %}
            {% if sps %}
            <ul class="list-unstyled">
              {% for sp in sps %}
              <li>{{ sp.name }}</li>
              {% endfor %}
            </ul>
            {% else %}
            —
            {% endif %}
            {% endwith %}
          </td>
        </tr>
        <tr>
          <td>{% trans "Workplace" %}:</td>
          <td>{{ user_object.workplace|default:"—" }}</td>
        </tr>
      </table>
    {% endif %}
    {% endif %}

    {% if has_curator_permissions and  user_object.cscuserreference_set.count > 0 %}
    {% if user_object.is_student or user_object.is_graduate %}
        <h4 class="_mtop-30">{% trans "Student references" %}:</h4>
          <ul>
            {% for reference in user_object.cscuserreference_set.all %}
            <li>
              <a href="{% url 'user_reference_detail' user_object.id reference.id %}">
                {{ reference.created|date:"d.m.Y" }}
              </a>
            </li>
            {% endfor %}
          </ul>
    {% endif %}
    {% endif %}

    </div>
<div class="col-xs-3 profile-sidebar">
    <div class="text-center">
    <div class="thumbnail-inner">
        <div class="thumbnail-img">
            {% if user_object.photo %}
                {% thumbnail user_object.photo "170x238" crop="center" cropbox=user_object.photo_thumbnail_cropbox as im %}
                    <img src="{{ im.url }}" width="{{ im.width }}"
                         height="{{ im.height }}">
                {% endthumbnail %}
            {% else %}
                <img src="{% static 'img/center/profile_no_photo.png' %}">
            {% endif %}
        </div>

    {% if user_object.pk == user.pk or user.is_curator %}
        <div class="photo-actions">
            <a href="#user-photo-upload">{% trans "Change photo" %}</a>
        </div>
    {% endif %}
    </div>
    </div>

    {% if user.is_authenticated %}
        <div class="clearfix"></div>
        <div class="list-group">
        {% if is_editing_allowed %}
            <a class="list-group-item" href="{% url 'user_update' user_object.pk %}"><i class="fa fa-cog"></i> {% trans "Edit" %}</a>
        {% endif %}
        {% if has_curator_permissions %}
            <a href="{% url 'admin:users_cscuser_change' user_object.pk %}" target="_blank" class="list-group-item">
                <i class="fa fa-pencil-square-o"></i> {% trans "Edit in admin" %}
            </a>
        {% endif %}
        {% if has_curator_permissions and user_object.enrollment_year %}
            {% if user_object.is_student or user_object.is_graduate %}
                <a href="{% url 'user_reference_add' user_object.pk %}" class="list-group-item"><i class="fa fa-file-text-o"></i> {% trans "Create reference" %}</a>
            {% endif %}
            {% if has_curator_permissions and user_object.studentinfo %}
                <a href="{% url 'student_info_update' user_object.studentinfo.pk %}" class="list-group-item">{% trans "Edit info record" %}</a>
            {% endif %}
            {% if user_object.pk == user.pk %}
                <a href="{% url 'password_change' %}" class="list-group-item">{% trans "Change password" %}</a>
            {% endif %}
        {% endif %}
        </div>
    {% endif %}
</div>
</div>
</div>
    {% include "users/_user_detail_upload_photo.html" %}
{% endblock content %}
